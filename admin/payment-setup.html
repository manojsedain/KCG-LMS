<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment & Notification Setup - LMS AI Assistant Admin</title>
    <link rel="stylesheet" href="../dist/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .payment-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .notification-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .settings-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-info { background: #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Header -->
    <header class="glass border-b border-white/10 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-credit-card text-2xl text-primary"></i>
                    <h1 class="text-xl font-bold">Payment & Notification Setup</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="../admin.html" class="glass px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Admin
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- PayPal Account Setup Guide -->
        <div id="paypalSetupGuide" class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl p-6 mb-8">
            <div class="flex items-start mb-6">
                <i class="fas fa-info-circle text-3xl text-blue-400 mr-4 mt-1"></i>
                <div>
                    <h2 class="text-2xl font-bold mb-2">üí∞ How to Set Up Your PayPal Account to Receive Payments</h2>
                    <p class="text-gray-300 mb-4">Follow these steps to configure your own PayPal account so all payments come directly to you:</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Step-by-Step Guide -->
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold text-blue-300 mb-4">üìã Setup Steps:</h3>
                    
                    <div class="bg-white/5 rounded-lg p-4 border-l-4 border-blue-500">
                        <h4 class="font-semibold text-blue-300 mb-2">1. Create PayPal Business Account</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Go to <a href="https://www.paypal.com/business" target="_blank" class="text-blue-400 hover:underline">paypal.com/business</a></p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Click "Sign Up" and choose "Business Account"</p>
                        <p class="text-sm text-gray-300">‚Ä¢ Complete business verification (required for API access)</p>
                    </div>
                    
                    <div class="bg-white/5 rounded-lg p-4 border-l-4 border-green-500">
                        <h4 class="font-semibold text-green-300 mb-2">2. Create PayPal App for API Access</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Login to <a href="https://developer.paypal.com" target="_blank" class="text-blue-400 hover:underline">developer.paypal.com</a></p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Go to "My Apps & Credentials"</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Click "Create App" under "REST API apps"</p>
                        <p class="text-sm text-gray-300">‚Ä¢ Choose your business account and "Merchant" features</p>
                    </div>
                    
                    <div class="bg-white/5 rounded-lg p-4 border-l-4 border-yellow-500">
                        <h4 class="font-semibold text-yellow-300 mb-2">3. Get Your API Credentials</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Copy "Client ID" from your created app</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Copy "Client Secret" (click "Show" to reveal)</p>
                        <p class="text-sm text-gray-300">‚Ä¢ Use "Sandbox" for testing, "Live" for production</p>
                    </div>
                    
                    <div class="bg-white/5 rounded-lg p-4 border-l-4 border-purple-500">
                        <h4 class="font-semibold text-purple-300 mb-2">4. Configure Below</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Paste your Client ID and Secret in the form below</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Set environment to "Sandbox" for testing</p>
                        <p class="text-sm text-gray-300">‚Ä¢ Switch to "Live" when ready for real payments</p>
                    </div>
                </div>
                
                <!-- Important Notes -->
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold text-yellow-300 mb-4">‚ö†Ô∏è Important Notes:</h3>
                    
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                        <h4 class="font-semibold text-yellow-300 mb-2">üí≥ Payment Flow</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Customers pay through PayPal checkout</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Money goes directly to YOUR PayPal account</p>
                        <p class="text-sm text-gray-300">‚Ä¢ You receive instant notifications of payments</p>
                    </div>
                    
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                        <h4 class="font-semibold text-green-300 mb-2">üîí Security</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ API credentials are stored securely</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Only you have access to your PayPal account</p>
                        <p class="text-sm text-gray-300">‚Ä¢ Payments are processed through PayPal's secure system</p>
                    </div>
                    
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-300 mb-2">üí∞ Fees & Withdrawal</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ PayPal charges ~2.9% + $0.30 per transaction</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ Withdraw to your bank account anytime</p>
                        <p class="text-sm text-gray-300">‚Ä¢ View all transactions in your PayPal dashboard</p>
                    </div>
                    
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                        <h4 class="font-semibold text-red-300 mb-2">üß™ Testing vs Live</h4>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ <strong>Sandbox:</strong> Use for testing (no real money)</p>
                        <p class="text-sm text-gray-300 mb-2">‚Ä¢ <strong>Live:</strong> Real payments to your account</p>
                        <p class="text-sm text-gray-300">‚Ä¢ Always test in sandbox first!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PayPal Configuration -->
        <div class="payment-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fab fa-paypal text-3xl text-blue-500 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">PayPal API Configuration</h2>
                    <p class="text-gray-400">Enter your PayPal app credentials from developer.paypal.com</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">PayPal Client ID</label>
                    <input type="text" id="paypalClientId" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter PayPal Client ID">
                    <p class="text-xs text-gray-400 mt-1">From your PayPal app in developer.paypal.com</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">PayPal Client Secret</label>
                    <input type="password" id="paypalClientSecret" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter PayPal Client Secret">
                    <p class="text-xs text-gray-400 mt-1">Keep this secret secure - never share publicly</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Environment</label>
                    <select id="paypalEnvironment" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="sandbox">Sandbox (Testing - No Real Money)</option>
                        <option value="live">Live (Production - Real Payments)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Always test in sandbox first!</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Payment System Status</label>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="paymentEnabled" class="mr-2">
                            <span>Enable Payment System</span>
                        </label>
                        <div id="connectionStatus" class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                            <span class="text-sm text-gray-400">Not connected</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PayPal Actions -->
            <div class="mt-6 flex flex-wrap gap-4">
                <button id="testPayPalConnection" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plug mr-2"></i>
                    Test Connection
                </button>
                <button id="savePayPalSettings" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    Save PayPal Settings
                </button>
            </div>
        </div>
        
        <!-- Payment History Display -->
        <div class="bg-gradient-to-r from-purple-600/20 to-blue-600/20 border border-purple-500/30 rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-history text-3xl text-purple-400 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">üí≥ Payment History</h2>
                    <p class="text-gray-300">View and manage payment transactions</p>
                </div>
            </div>
            
            <div id="paymentsContainer" class="space-y-4">
                <div class="text-gray-400 text-center py-8">Loading payment history...</div>
            </div>
        </div>
        
        <!-- Notification Logs Display -->
        <div class="bg-gradient-to-r from-green-600/20 to-teal-600/20 border border-green-500/30 rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-bell text-3xl text-green-400 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">üìß Notification Logs</h2>
                    <p class="text-gray-300">View email notification history and status</p>
                </div>
            </div>
            
            <div id="notificationsContainer" class="space-y-4">
                <div class="text-gray-400 text-center py-8">Loading notification logs...</div>
            </div>
        </div>

        <!-- Pricing Configuration -->
        <div class="settings-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-dollar-sign text-3xl text-yellow-500 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">Pricing Configuration</h2>
                    <p class="text-gray-400">Set discount and lifetime pricing</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Discount Price (USD)</label>
                    <input type="number" id="discountPrice" step="0.01" min="0" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="36.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Lifetime Price (USD)</label>
                    <input type="number" id="lifetimePrice" step="0.01" min="0" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="68.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Discount End Date</label>
                    <input type="date" id="discountEndDate" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
            </div>
            
            <div class="mt-6">
                <label class="block text-sm font-medium mb-2">Admin Email Addresses (Free Access)</label>
                <input type="text" id="adminUsernames" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="admin@example.com,developer@company.com" title="Comma-separated list of email addresses">
                <p class="text-xs text-gray-400 mt-1">Comma-separated list of email addresses that get free access (no payment required)</p>
            </div>
        </div>

        <!-- Notification Configuration -->
        <div class="notification-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-bell text-3xl text-green-500 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">Notification Configuration</h2>
                    <p class="text-gray-400">Configure email notifications for payments and device approvals</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Developer Email</label>
                    <input type="email" id="developerEmail" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="developer@example.com">
                    <p class="text-xs text-gray-400 mt-1">Receives payment receipts and device approval requests</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Notification Email</label>
                    <input type="email" id="notificationEmail" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="notifications@example.com">
                    <p class="text-xs text-gray-400 mt-1">General system notifications</p>
                </div>
            </div>
        </div>

        <!-- Payment Management -->
        <div class="glass rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-receipt text-3xl text-purple-500 mr-4"></i>
                    <div>
                        <h2 class="text-2xl font-bold">Payment Management</h2>
                        <p class="text-gray-400">View and manage payment records</p>
                    </div>
                </div>
                <button onclick="loadPayments()" class="glass px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>
                    Refresh
                </button>
            </div>
            
            <div id="paymentsTable" class="overflow-x-auto">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading payments...</p>
                </div>
            </div>
        </div>

        <!-- Notification Logs -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-envelope text-3xl text-blue-500 mr-4"></i>
                    <div>
                        <h2 class="text-2xl font-bold">Notification Logs</h2>
                        <p class="text-gray-400">View sent notifications and their status</p>
                    </div>
                </div>
                <button onclick="loadNotifications()" class="glass px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>
                    Refresh
                </button>
            </div>
            
            <div id="notificationsTable" class="overflow-x-auto">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading notifications...</p>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="fixed bottom-6 right-6">
            <button onclick="saveSettings()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/80 hover:to-secondary/80 text-white font-semibold py-4 px-8 rounded-full shadow-lg transition duration-200">
                <i class="fas fa-save mr-2"></i>
                Save Settings
            </button>
        </div>
    </main>

    <script>
        // Authentication check - use adminSession from main admin panel
        let token = null;
        const adminSession = localStorage.getItem('adminSession');
        if (adminSession) {
            try {
                const sessionData = JSON.parse(adminSession);
                const now = Date.now();
                const sessionExpiry = sessionData.expires || sessionData.expiry;
                
                if (sessionData.token && sessionExpiry > now) {
                    token = sessionData.token;
                } else {
                    // Session expired, redirect back to admin panel
                    alert('Session expired. Please log in to the admin panel again.');
                    window.location.href = '../admin.html';
                }
            } catch (error) {
                console.error('Session validation error:', error);
                alert('Invalid session. Please log in to the admin panel again.');
                window.location.href = '../admin.html';
            }
        } else {
            // No session found, redirect back to admin panel
            alert('Please access this page through the admin panel.');
            window.location.href = '../admin.html';
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSettings',
                        token: token
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const settings = data.settings;
                    
                    // Populate form fields - use backend field names
                    document.getElementById('paypalClientId').value = settings.paypal_client_id || '';
                    document.getElementById('paypalClientSecret').value = settings.paypal_client_secret || '';
                    document.getElementById('paypalEnvironment').value = settings.paypal_environment || 'sandbox';
                    document.getElementById('paymentEnabled').checked = settings.payment_enabled === 'true';
                    document.getElementById('discountPrice').value = settings.discount_price || '36.00';
                    document.getElementById('lifetimePrice').value = settings.lifetime_price || '68.00';
                    document.getElementById('discountEndDate').value = settings.discount_end_date || '2025-08-31';
                    document.getElementById('adminUsernames').value = settings.admin_usernames || 'admin,ADMIN';
                    document.getElementById('developerEmail').value = settings.developer_email || '';
                    document.getElementById('notificationEmail').value = settings.notification_email || '';
                    
                    // Hide setup guide if PayPal is already configured
                    const paypalConfigured = settings.paypal_client_id && settings.paypal_client_secret;
                    const setupGuide = document.getElementById('paypalSetupGuide');
                    if (paypalConfigured && setupGuide) {
                        setupGuide.style.display = 'none';
                    }
                    
                    // Populate alternative payment methods
                    document.getElementById('bankName').value = settings.alt_payment_bankName || '';
                    document.getElementById('accountHolder').value = settings.alt_payment_accountHolder || '';
                    document.getElementById('accountNumber').value = settings.alt_payment_accountNumber || '';
                    document.getElementById('swiftCode').value = settings.alt_payment_swiftCode || '';
                    document.getElementById('bitcoinAddress').value = settings.alt_payment_bitcoinAddress || '';
                    document.getElementById('ethereumAddress').value = settings.alt_payment_ethereumAddress || '';
                    document.getElementById('otherPaymentMethod').value = settings.alt_payment_otherPaymentMethod || '';
                    document.getElementById('paymentInstructions').value = settings.alt_payment_paymentInstructions || '';
                } else {
                    showToast('Failed to load settings: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings', 'error');
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                const settings = {
                    paypal_client_id: document.getElementById('paypalClientId').value,
                    paypal_client_secret: document.getElementById('paypalClientSecret').value,
                    paypal_environment: document.getElementById('paypalEnvironment').value,
                    payment_enabled: document.getElementById('paymentEnabled').checked ? 'true' : 'false',
                    discount_price: document.getElementById('discountPrice').value,
                    lifetime_price: document.getElementById('lifetimePrice').value,
                    discount_end_date: document.getElementById('discountEndDate').value,
                    admin_usernames: document.getElementById('adminUsernames').value,
                    developer_email: document.getElementById('developerEmail').value,
                    notification_email: document.getElementById('notificationEmail').value
                };

                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        token: token,
                        settings: settings
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Settings saved successfully!', 'success');
                } else {
                    showToast('Failed to save settings: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Error saving settings', 'error');
            }
        }

        // Load payments
        async function loadPayments() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getPayments',
                        token: token
                    })
                });

                const data = await response.json();
                if (data.success) {
                    renderPaymentsTable(data.payments);
                } else {
                    showToast('Failed to load payments: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                showToast('Error loading payments', 'error');
            }
        }

        // Render payments table
        function renderPaymentsTable(payments) {
            const container = document.getElementById('paymentsTable');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400"><p>No payments found</p></div>';
                return;
            }

            const table = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="text-left py-3 px-4">Username</th>
                            <th class="text-left py-3 px-4">Email</th>
                            <th class="text-left py-3 px-4">Amount</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Date</th>
                            <th class="text-left py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payments.map(payment => `
                            <tr class="border-b border-white/10">
                                <td class="py-3 px-4">${payment.username}</td>
                                <td class="py-3 px-4">${payment.email || 'N/A'}</td>
                                <td class="py-3 px-4">$${payment.amount}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs ${getStatusColor(payment.payment_status)}">
                                        ${payment.payment_status}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${new Date(payment.created_at).toLocaleDateString()}</td>
                                <td class="py-3 px-4">
                                    <div class="flex space-x-2">
                                        ${payment.payment_proof_url ? `<button onclick="viewPaymentProof('${payment.payment_proof_url}')" class="text-blue-400 hover:text-blue-300 text-sm">View Proof</button>` : ''}
                                        <button onclick="deletePayment('${payment.id}')" class="text-red-400 hover:text-red-300 text-sm" title="Delete Payment">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Get status color class
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'bg-green-600';
                case 'pending': return 'bg-yellow-600';
                case 'pending_verification': return 'bg-orange-600';
                case 'failed': return 'bg-red-600';
                default: return 'bg-gray-600';
            }
        }

        // View payment proof
        function viewPaymentProof(proofUrl) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 max-w-2xl max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Payment Proof</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <img src="${proofUrl}" alt="Payment Proof" class="max-w-full h-auto">
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Display notifications
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            if (!container) {
                console.warn('Notifications container not found');
                return;
            }
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No notifications found</p>';
                return;
            }
            
            const table = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="text-left py-3 px-4">Type</th>
                            <th class="text-left py-3 px-4">Recipient</th>
                            <th class="text-left py-3 px-4">Subject</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${notifications.map(notification => `
                            <tr class="border-b border-white/10 hover:bg-white/5">
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs bg-blue-600">${notification.notification_type}</span>
                                </td>
                                <td class="py-3 px-4">${notification.recipient_email}</td>
                                <td class="py-3 px-4">${notification.subject || 'N/A'}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs ${getNotificationStatusColor(notification.status)}">${notification.status}</span>
                                </td>
                                <td class="py-3 px-4">${new Date(notification.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        // Get notification status color
        function getNotificationStatusColor(status) {
            switch (status) {
                case 'sent': return 'bg-green-600';
                case 'pending': return 'bg-yellow-600';
                case 'failed': return 'bg-red-600';
                default: return 'bg-gray-600';
            }
        }
        
        // Delete payment record
        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment record? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deletePayment',
                        token: token,
                        paymentId: paymentId
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Payment record deleted successfully', 'success');
                    loadPayments(); // Reload the payments table
                } else {
                    showToast('Failed to delete payment: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Delete payment error:', error);
                showToast('Failed to delete payment', 'error');
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getNotifications',
                        token: token
                    })
                });

                const data = await response.json();
                if (data.success) {
                    renderNotificationsTable(data.notifications);
                } else {
                    showToast('Failed to load notifications: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                showToast('Error loading notifications', 'error');
            }
        }

        // Render notifications table
        function renderNotificationsTable(notifications) {
            const container = document.getElementById('notificationsTable');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400"><p>No notifications found</p></div>';
                return;
            }

            const table = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="text-left py-3 px-4">Type</th>
                            <th class="text-left py-3 px-4">Recipient</th>
                            <th class="text-left py-3 px-4">Subject</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${notifications.map(notification => `
                            <tr class="border-b border-white/10">
                                <td class="py-3 px-4">${notification.notification_type}</td>
                                <td class="py-3 px-4">${notification.recipient_email}</td>
                                <td class="py-3 px-4">${notification.subject}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs ${getStatusColor(notification.status)}">
                                        ${notification.status}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${new Date(notification.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Test PayPal connection
        async function testPayPalConnection() {
            const clientId = document.getElementById('paypalClientId').value;
            const clientSecret = document.getElementById('paypalClientSecret').value;
            const environment = document.getElementById('paypalEnvironment').value;
            
            if (!clientId || !clientSecret) {
                showToast('Please enter both Client ID and Client Secret', 'error');
                return;
            }
            
            const button = document.getElementById('testPayPalConnection');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
            button.disabled = true;
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session?.token) {
                    showToast('Admin session expired', 'error');
                    return;
                }
                
                const response = await fetch('/.netlify/functions/processPayment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'testConnection',
                        token: session.token,
                        clientId: clientId,
                        clientSecret: clientSecret,
                        environment: environment
                    })
                });
                
                const result = await response.json();
                const statusElement = document.getElementById('connectionStatus');
                
                if (result.success) {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-sm text-green-400">Connected successfully</span>
                    `;
                    showToast('PayPal connection successful!', 'success');
                } else {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-sm text-red-400">Connection failed</span>
                    `;
                    showToast('PayPal connection failed: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showToast('Connection test failed', 'error');
                const statusElement = document.getElementById('connectionStatus');
                statusElement.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="text-sm text-red-400">Connection failed</span>
                `;
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Test PayPal connection silently (without button interaction)
        async function testPayPalConnectionSilent() {
            try {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span class="text-sm text-yellow-400">Testing connection...</span>
                `;
                
                const response = await fetch('/.netlify/functions/processPayment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'testConnection',
                        token: token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-sm text-green-400">Connected successfully</span>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-sm text-red-400">Connection failed: ${result.message || 'Unknown error'}</span>
                    `;
                }
            } catch (error) {
                console.error('Silent connection test error:', error);
                const statusElement = document.getElementById('connectionStatus');
                statusElement.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="text-sm text-red-400">Connection failed</span>
                `;
            }
        }
        
        // Load PayPal settings on page load
        async function loadSettings() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSettings',
                        token: token
                    })
                });
                
                const result = await response.json();
                console.log('Load settings result:', result);
                
                if (result.success && result.settings) {
                    const settings = result.settings;
                    
                    // PayPal settings - map backend field names to form fields
                    if (settings.paypal_client_id) document.getElementById('paypalClientId').value = settings.paypal_client_id;
                    if (settings.paypal_client_secret) document.getElementById('paypalClientSecret').value = settings.paypal_client_secret;
                    if (settings.paypal_environment) document.getElementById('paypalEnvironment').value = settings.paypal_environment;
                    if (settings.payment_enabled !== undefined) document.getElementById('paymentEnabled').checked = settings.payment_enabled === 'true';
                    
                    // Admin settings
                    if (settings.admin_emails) document.getElementById('adminEmails').value = settings.admin_emails;
                    
                    // Pricing settings
                    if (settings.discount_price) document.getElementById('discountPrice').value = settings.discount_price;
                    if (settings.lifetime_price) document.getElementById('lifetimePrice').value = settings.lifetime_price;
                    if (settings.discount_end_date) document.getElementById('discountEndDate').value = settings.discount_end_date;
                    
                    // Notification settings
                    if (settings.notification_email) document.getElementById('notificationEmail').value = settings.notification_email;
                    if (settings.emailjs_service_id) document.getElementById('emailjsServiceId').value = settings.emailjs_service_id;
                    if (settings.emailjs_template_id) document.getElementById('emailjsTemplateId').value = settings.emailjs_template_id;
                    if (settings.emailjs_user_id) document.getElementById('emailjsUserId').value = settings.emailjs_user_id;
                    
                    console.log('Settings loaded successfully:', settings);
                    
                    // Auto-test PayPal connection if credentials are present
                    if (settings.paypal_client_id && settings.paypal_client_secret) {
                        setTimeout(testPayPalConnection, 1000);
                    }
                } else {
                    console.error('Failed to load settings:', result.message);
                }
            } catch (error) {
                console.error('Load settings error:', error);
            }
        }
        
        // Save PayPal settings
        async function savePayPalSettings() {
            const settings = {
                paypal_client_id: document.getElementById('paypalClientId').value,
                paypal_client_secret: document.getElementById('paypalClientSecret').value,
                paypal_environment: document.getElementById('paypalEnvironment').value,
                payment_enabled: document.getElementById('paymentEnabled').checked ? 'true' : 'false'
            };
            
            if (!settings.paypal_client_id || !settings.paypal_client_secret) {
                showToast('Please enter both PayPal Client ID and Secret', 'error');
                return;
            }
            
            console.log('Saving PayPal settings:', settings);
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        token: token,
                        settings: settings
                    })
                });
                
                const result = await response.json();
                console.log('PayPal save result:', result);
                
                if (result.success) {
                    showToast('PayPal settings saved successfully!', 'success');
                    // Reload settings to confirm they were saved
                    setTimeout(() => {
                        loadSettings();
                    }, 1000);
                } else {
                    showToast('Failed to save settings: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Save settings error:', error);
                showToast('Failed to save settings', 'error');
            }
        }
        
        // Load payment history
        async function loadPayments() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getPayments',
                        token: token
                    })
                });
                
                const result = await response.json();
                if (result.success && result.payments) {
                    displayPayments(result.payments);
                }
            } catch (error) {
                console.error('Load payments error:', error);
                showToast('Failed to load payment history', 'error');
            }
        }
        
        // Display payments in the UI
        function displayPayments(payments) {
            const paymentsContainer = document.getElementById('paymentsContainer');
            if (!paymentsContainer) {
                console.error('Payments container not found');
                return;
            }
            
            if (!payments || payments.length === 0) {
                paymentsContainer.innerHTML = '<div class="text-gray-400 text-center py-8">No payment records found</div>';
                return;
            }
            
            const paymentsHTML = payments.map(payment => {
                const statusColor = payment.payment_status === 'completed' ? 'text-green-400' : 
                                  payment.payment_status === 'failed' ? 'text-red-400' : 'text-yellow-400';
                const methodIcon = payment.payment_method === 'paypal' ? 'üí≥' : 'üìÑ';
                
                return `
                    <div class="bg-white/10 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${methodIcon}</span>
                                <div>
                                    <div class="font-semibold text-white">${payment.email}</div>
                                    <div class="text-sm text-gray-400">$${payment.amount} USD</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="${statusColor} font-semibold capitalize">${payment.payment_status}</div>
                                <div class="text-sm text-gray-400">${new Date(payment.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        ${payment.paypal_transaction_id ? `<div class="text-xs text-gray-500 mt-2">Transaction: ${payment.paypal_transaction_id}</div>` : ''}
                        ${payment.admin_notes ? `<div class="text-xs text-blue-300 mt-2">Notes: ${payment.admin_notes}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            paymentsContainer.innerHTML = paymentsHTML;
        }
        
        // Display notifications in the UI
        function displayNotifications(notifications) {
            const notificationsContainer = document.getElementById('notificationsContainer');
            if (!notificationsContainer) {
                console.error('Notifications container not found');
                return;
            }
            
            if (!notifications || notifications.length === 0) {
                notificationsContainer.innerHTML = '<div class="text-gray-400 text-center py-8">No notification logs found</div>';
                return;
            }
            
            const notificationsHTML = notifications.map(notification => {
                const statusColor = notification.status === 'sent' ? 'text-green-400' : 
                                  notification.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
                const typeIcon = notification.notification_type === 'payment' ? 'üí∞' : 
                               notification.notification_type === 'device' ? 'üì±' : 'üìß';
                
                return `
                    <div class="bg-white/10 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${typeIcon}</span>
                                <div>
                                    <div class="font-semibold text-white">${notification.recipient_email}</div>
                                    <div class="text-sm text-gray-400">${notification.subject || 'No subject'}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="${statusColor} font-semibold capitalize">${notification.status}</div>
                                <div class="text-sm text-gray-400">${new Date(notification.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        ${notification.error_message ? `<div class="text-xs text-red-300 mt-2">Error: ${notification.error_message}</div>` : ''}
                        ${notification.message ? `<div class="text-xs text-gray-300 mt-2 max-w-md truncate">${notification.message}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            notificationsContainer.innerHTML = notificationsHTML;
        }
        
        // Load notification logs
        async function loadNotifications() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getNotifications',
                        token: token
                    })
                });
                
                const result = await response.json();
                if (result.success && result.notifications) {
                    displayNotifications(result.notifications);
                }
            } catch (error) {
                console.error('Load notifications error:', error);
                showToast('Failed to load notifications', 'error');
            }
        }
        
        // Save alternative payment methods
        async function saveAlternativePayments() {
            const altPayments = {
                bankName: document.getElementById('bankName').value,
                accountHolder: document.getElementById('accountHolder').value,
                accountNumber: document.getElementById('accountNumber').value,
                swiftCode: document.getElementById('swiftCode').value,
                bitcoinAddress: document.getElementById('bitcoinAddress').value,
                ethereumAddress: document.getElementById('ethereumAddress').value,
                otherPaymentMethod: document.getElementById('otherPaymentMethod').value,
                paymentInstructions: document.getElementById('paymentInstructions').value
            };
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateAlternativePayments',
                        token: token,
                        altPayments: altPayments
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Alternative payment methods saved successfully!', 'success');
                } else {
                    showToast('Failed to save payment methods: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Save alt payments error:', error);
                showToast('Failed to save payment methods', 'error');
            }
        }
        
        // Save admin settings
        async function saveAdminSettings() {
            const settings = {
                admin_emails: document.getElementById('adminEmails').value
            };
            
            console.log('Saving admin settings:', settings);
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        token: token,
                        settings: settings
                    })
                });
                
                const result = await response.json();
                console.log('Admin save result:', result);
                
                if (result.success) {
                    showToast('Admin settings saved successfully!', 'success');
                } else {
                    showToast('Failed to save settings: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Save admin settings error:', error);
                showToast('Failed to save admin settings', 'error');
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadPayments();
            loadNotifications();
            
            // PayPal event listeners
            const testButton = document.getElementById('testPayPalConnection');
            const saveButton = document.getElementById('savePayPalSettings');
            
            if (testButton) {
                testButton.addEventListener('click', testPayPalConnection);
            }
            if (saveButton) {
                saveButton.addEventListener('click', savePayPalSettings);
            }
        });
    </script>
</body>
</html>
