<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment & Notification Setup - LMS AI Assistant Admin</title>
    <link rel="stylesheet" href="../dist/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .payment-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .notification-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .settings-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        .toast-info { background: #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Header -->
    <header class="glass border-b border-white/10 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-credit-card text-2xl text-primary"></i>
                    <h1 class="text-xl font-bold">Payment & Notification Setup</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="glass px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Admin
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- PayPal Configuration -->
        <div class="payment-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fab fa-paypal text-3xl text-blue-500 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">PayPal Configuration</h2>
                    <p class="text-gray-400">Configure PayPal integration for automatic payments</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">PayPal Client ID</label>
                    <input type="text" id="paypalClientId" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter PayPal Client ID">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">PayPal Client Secret</label>
                    <input type="password" id="paypalClientSecret" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter PayPal Client Secret">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Environment</label>
                    <select id="paypalEnvironment" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="sandbox">Sandbox (Testing)</option>
                        <option value="live">Live (Production)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Payment Status</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="paymentEnabled" class="mr-2">
                            <span>Enable Payment System</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Configuration -->
        <div class="settings-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-dollar-sign text-3xl text-yellow-500 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">Pricing Configuration</h2>
                    <p class="text-gray-400">Set discount and lifetime pricing</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Discount Price (USD)</label>
                    <input type="number" id="discountPrice" step="0.01" min="0" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="36.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Lifetime Price (USD)</label>
                    <input type="number" id="lifetimePrice" step="0.01" min="0" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="68.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Discount End Date</label>
                    <input type="date" id="discountEndDate" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
            </div>
            
            <div class="mt-6">
                <label class="block text-sm font-medium mb-2">Admin Usernames (Free Access)</label>
                <input type="text" id="adminUsernames" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="admin,ADMIN,developer" title="Comma-separated list of usernames">
                <p class="text-xs text-gray-400 mt-1">Comma-separated list of usernames that get free access</p>
            </div>
        </div>

        <!-- Notification Configuration -->
        <div class="notification-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-6">
                <i class="fas fa-bell text-3xl text-green-500 mr-4"></i>
                <div>
                    <h2 class="text-2xl font-bold">Notification Configuration</h2>
                    <p class="text-gray-400">Configure email notifications for payments and device approvals</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Developer Email</label>
                    <input type="email" id="developerEmail" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="developer@example.com">
                    <p class="text-xs text-gray-400 mt-1">Receives payment receipts and device approval requests</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Notification Email</label>
                    <input type="email" id="notificationEmail" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="notifications@example.com">
                    <p class="text-xs text-gray-400 mt-1">General system notifications</p>
                </div>
            </div>
        </div>

        <!-- Payment Management -->
        <div class="glass rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-receipt text-3xl text-purple-500 mr-4"></i>
                    <div>
                        <h2 class="text-2xl font-bold">Payment Management</h2>
                        <p class="text-gray-400">View and manage payment records</p>
                    </div>
                </div>
                <button onclick="loadPayments()" class="glass px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>
                    Refresh
                </button>
            </div>
            
            <div id="paymentsTable" class="overflow-x-auto">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading payments...</p>
                </div>
            </div>
        </div>

        <!-- Notification Logs -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-envelope text-3xl text-blue-500 mr-4"></i>
                    <div>
                        <h2 class="text-2xl font-bold">Notification Logs</h2>
                        <p class="text-gray-400">View sent notifications and their status</p>
                    </div>
                </div>
                <button onclick="loadNotifications()" class="glass px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>
                    Refresh
                </button>
            </div>
            
            <div id="notificationsTable" class="overflow-x-auto">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading notifications...</p>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="fixed bottom-6 right-6">
            <button onclick="saveSettings()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/80 hover:to-secondary/80 text-white font-semibold py-4 px-8 rounded-full shadow-lg transition duration-200">
                <i class="fas fa-save mr-2"></i>
                Save Settings
            </button>
        </div>
    </main>

    <script>
        // Authentication check
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSettings',
                        token: token
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const settings = data.settings;
                    
                    // Populate form fields
                    document.getElementById('paypalClientId').value = settings.paypal_client_id || '';
                    document.getElementById('paypalClientSecret').value = settings.paypal_client_secret || '';
                    document.getElementById('paypalEnvironment').value = settings.paypal_environment || 'sandbox';
                    document.getElementById('paymentEnabled').checked = settings.payment_enabled === 'true';
                    document.getElementById('discountPrice').value = settings.discount_price || '36.00';
                    document.getElementById('lifetimePrice').value = settings.lifetime_price || '68.00';
                    document.getElementById('discountEndDate').value = settings.discount_end_date || '2025-08-31';
                    document.getElementById('adminUsernames').value = settings.admin_usernames || 'admin,ADMIN';
                    document.getElementById('developerEmail').value = settings.developer_email || '';
                    document.getElementById('notificationEmail').value = settings.notification_email || '';
                } else {
                    showToast('Failed to load settings: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings', 'error');
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                const settings = {
                    paypal_client_id: document.getElementById('paypalClientId').value,
                    paypal_client_secret: document.getElementById('paypalClientSecret').value,
                    paypal_environment: document.getElementById('paypalEnvironment').value,
                    payment_enabled: document.getElementById('paymentEnabled').checked ? 'true' : 'false',
                    discount_price: document.getElementById('discountPrice').value,
                    lifetime_price: document.getElementById('lifetimePrice').value,
                    discount_end_date: document.getElementById('discountEndDate').value,
                    admin_usernames: document.getElementById('adminUsernames').value,
                    developer_email: document.getElementById('developerEmail').value,
                    notification_email: document.getElementById('notificationEmail').value
                };

                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        token: token,
                        settings: settings
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Settings saved successfully!', 'success');
                } else {
                    showToast('Failed to save settings: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Error saving settings', 'error');
            }
        }

        // Load payments
        async function loadPayments() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getPayments',
                        token: token
                    })
                });

                const data = await response.json();
                if (data.success) {
                    renderPaymentsTable(data.payments);
                } else {
                    showToast('Failed to load payments: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                showToast('Error loading payments', 'error');
            }
        }

        // Render payments table
        function renderPaymentsTable(payments) {
            const container = document.getElementById('paymentsTable');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400"><p>No payments found</p></div>';
                return;
            }

            const table = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="text-left py-3 px-4">Username</th>
                            <th class="text-left py-3 px-4">Email</th>
                            <th class="text-left py-3 px-4">Amount</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Date</th>
                            <th class="text-left py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${payments.map(payment => `
                            <tr class="border-b border-white/10">
                                <td class="py-3 px-4">${payment.username}</td>
                                <td class="py-3 px-4">${payment.email || 'N/A'}</td>
                                <td class="py-3 px-4">$${payment.amount}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs ${getStatusColor(payment.payment_status)}">
                                        ${payment.payment_status}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${new Date(payment.created_at).toLocaleDateString()}</td>
                                <td class="py-3 px-4">
                                    ${payment.payment_proof_url ? `<button onclick="viewPaymentProof('${payment.payment_proof_url}')" class="text-blue-400 hover:text-blue-300">View Proof</button>` : 'N/A'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Get status color class
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'bg-green-600';
                case 'pending': return 'bg-yellow-600';
                case 'pending_verification': return 'bg-orange-600';
                case 'failed': return 'bg-red-600';
                default: return 'bg-gray-600';
            }
        }

        // View payment proof
        function viewPaymentProof(proofUrl) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 max-w-2xl max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Payment Proof</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <img src="${proofUrl}" alt="Payment Proof" class="max-w-full h-auto">
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getNotifications',
                        token: token
                    })
                });

                const data = await response.json();
                if (data.success) {
                    renderNotificationsTable(data.notifications);
                } else {
                    showToast('Failed to load notifications: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                showToast('Error loading notifications', 'error');
            }
        }

        // Render notifications table
        function renderNotificationsTable(notifications) {
            const container = document.getElementById('notificationsTable');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400"><p>No notifications found</p></div>';
                return;
            }

            const table = `
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="text-left py-3 px-4">Type</th>
                            <th class="text-left py-3 px-4">Recipient</th>
                            <th class="text-left py-3 px-4">Subject</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${notifications.map(notification => `
                            <tr class="border-b border-white/10">
                                <td class="py-3 px-4">${notification.notification_type}</td>
                                <td class="py-3 px-4">${notification.recipient_email}</td>
                                <td class="py-3 px-4">${notification.subject}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs ${getStatusColor(notification.status)}">
                                        ${notification.status}
                                    </span>
                                </td>
                                <td class="py-3 px-4">${new Date(notification.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadPayments();
            loadNotifications();
        });
    </script>
</body>
</html>
