<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS AI Assistant - Admin Panel</title>
    <meta name="description" content="Administrative control panel for LMS AI Assistant">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https:;">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e293b">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/dist/styles.css">

    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    

    
    <style>
        :root {
            /* Default Dark Theme */
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0f172a 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.2);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
            --bg-secondary: rgba(0, 0, 0, 0.05);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #6366f1;
        }
        
        [data-theme="blue"] {
            --bg-primary: linear-gradient(135deg, #0c4a6e 0%, #1e40af 50%, #0c4a6e 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #bfdbfe;
            --border-color: rgba(255, 255, 255, 0.2);
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
        }
        
        [data-theme="green"] {
            --bg-primary: linear-gradient(135deg, #064e3b 0%, #166534 50%, #064e3b 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #bbf7d0;
            --border-color: rgba(255, 255, 255, 0.2);
            --accent-primary: #10b981;
            --accent-secondary: #34d399;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .glass {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }
        
        .text-secondary {
            color: var(--text-secondary) !important;
        }
        
        .theme-selector {
            position: relative;
        }
        
        .theme-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            min-width: 150px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .theme-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .theme-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .theme-preview {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid var(--border-color);
        }
        
        .theme-preview.dark {
            background: linear-gradient(45deg, #0f172a, #581c87);
        }
        
        .theme-preview.light {
            background: linear-gradient(45deg, #f8fafc, #e2e8f0);
        }
        
        .theme-preview.blue {
            background: linear-gradient(45deg, #0c4a6e, #1e40af);
        }
        
        .theme-preview.green {
            background: linear-gradient(45deg, #064e3b, #166534);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { background: var(--accent-primary, #10b981); }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        .toast.info { background: var(--accent-secondary, #06b6d4); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-white">
    <!-- Toast Container -->
    <div id="toastContainer"></div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center z-50">
        <div class="glass rounded-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-2xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">Admin Access</h1>
                <p class="text-gray-300">Enter your credentials to continue</p>
            </div>
            
            <form id="loginForm" class="space-y-6" method="post" action="javascript:void(0)">
                <div>
                    <label class="block text-sm font-medium mb-2">Admin Password</label>
                    <input type="password" id="adminPassword" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter admin password" required>
                </div>
                
                <div id="twoFactorSection" class="hidden">
                    <label class="block text-sm font-medium mb-2">Two-Factor Code</label>
                    <input type="text" id="twoFactorCode" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter 6-digit code" maxlength="6">
                </div>
                
                <button type="submit" id="loginBtn" class="w-full bg-gradient-to-r from-primary to-secondary hover:from-primary/80 hover:to-secondary/80 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <span id="loginBtnText">Sign In</span>
                    <div id="loginSpinner" class="loading-spinner mx-auto hidden"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Main Admin Interface -->
    <div id="adminInterface" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-0 h-full w-64 glass z-40">
            <div class="p-6">
                <div class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                        <i class="fas fa-cog text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">Admin Panel</h1>
                        <p class="text-xs text-gray-400">LMS AI Assistant</p>
                    </div>
                </div>
                
                <nav class="space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors active bg-white/20">
                        <i class="fas fa-tachometer-alt w-5"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#script-management" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors">
                        <i class="fas fa-code w-5"></i>
                        <span>Script Management</span>
                    </a>
                    <a href="#system-settings" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors">
                        <i class="fas fa-cogs w-5"></i>
                        <span>System Settings</span>
                    </a>
                    <a href="#notifications" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors">
                        <i class="fas fa-bell w-5"></i>
                        <span>Notifications</span>
                    </a>
                    <a href="#logs" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors">
                        <i class="fas fa-file-alt w-5"></i>
                        <span>Logs</span>
                    </a>
                    <a href="#devices" class="nav-link flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors">
                        <i class="fas fa-laptop w-5"></i>
                        <span>Device Management</span>
                    </a>
                </nav>
                
                <div class="absolute bottom-6 left-6 right-6">
                    <button id="logoutBtn" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-red-600/20 hover:bg-red-600/30 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="ml-64">
            <!-- Header -->
            <header class="glass border-b border-white/10 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="pageTitle" class="text-2xl font-bold">Dashboard</h2>
                        <p id="pageSubtitle" class="text-gray-400">System overview and statistics</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-400">Last login</p>
                            <p id="lastLogin" class="text-sm font-medium">Loading...</p>
                        </div>
                        
                        <!-- Theme Selector -->
                        <div class="theme-selector">
                            <button id="themeToggle" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-lg flex items-center justify-center transition-colors">
                                <i class="fas fa-palette text-white"></i>
                            </button>
                            <div id="themeDropdown" class="theme-dropdown hidden">
                                <div class="theme-option" data-theme="dark">
                                    <div class="theme-preview dark"></div>
                                    <span class="text-sm">Dark</span>
                                </div>
                                <div class="theme-option" data-theme="light">
                                    <div class="theme-preview light"></div>
                                    <span class="text-sm">Light</span>
                                </div>
                                <div class="theme-option" data-theme="blue">
                                    <div class="theme-preview blue"></div>
                                    <span class="text-sm">Ocean Blue</span>
                                </div>
                                <div class="theme-option" data-theme="green">
                                    <div class="theme-preview green"></div>
                                    <span class="text-sm">Forest Green</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="p-6">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Registered Users</p>
                                    <p id="registeredUsersCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-user-plus text-primary"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Script Version</p>
                                    <p id="currentVersion" class="text-2xl font-bold">v1.0.0</p>
                                </div>
                                <div class="w-12 h-12 bg-secondary/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-code text-secondary"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">System Status</p>
                                    <p id="systemStatus" class="text-2xl font-bold text-success">Online</p>
                                </div>
                                <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Last Update</p>
                                    <p id="lastUpdate" class="text-2xl font-bold">Today</p>
                                </div>
                                <div class="w-12 h-12 bg-accent/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-accent"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token Usage Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Tokens Used</p>
                                    <p id="totalTokensCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-coins text-blue-500"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Active Users</p>
                                    <p id="activeUsersCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-green-500"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Avg Tokens/User</p>
                                    <p id="avgTokensPerUser" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-line text-purple-500"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Top Feature</p>
                                    <p id="topFeature" class="text-2xl font-bold">N/A</p>
                                </div>
                                <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-star text-orange-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Token Usage Table -->
                    <div class="glass rounded-xl p-6 mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">User Token Usage</h3>
                            <button onclick="loadUserTokenUsage()" class="bg-primary hover:bg-primary/80 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-refresh mr-1"></i>Refresh
                            </button>
                        </div>
                        <div id="userTokenTable" class="space-y-2">
                            <div class="text-center py-4 text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading user token usage...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Users and Recent Activity -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Top Token Users</h3>
                            <div id="topUsersTable" class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                    <span class="text-sm text-gray-400">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Recent Token Activity</h3>
                            <div id="recentTokenActivity" class="space-y-4">
                                <div class="flex items-center space-x-3 p-3 bg-white/5 rounded-lg">
                                    <div class="w-8 h-8 bg-success/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-coins text-success text-xs"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium">Token tracking initialized</p>
                                        <p class="text-xs text-gray-400">Just now</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Script Management Section -->
                <div id="script-management-section" class="content-section hidden">
                    <!-- Upload Script -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Upload New Script</h3>
                            <button id="uploadScriptBtn" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-upload mr-2"></i>Upload Script File
                            </button>
                        </div>
                        
                        <div id="uploadForm" class="hidden">
                            <!-- File Upload Area -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium mb-2">Upload Script File</label>
                                <div id="fileUploadArea" class="border-2 border-dashed border-white/20 rounded-lg p-8 text-center hover:border-primary/50 transition-colors cursor-pointer bg-white/5">
                                    <div id="uploadPlaceholder">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-lg font-medium mb-2">Drop your script file here</p>
                                        <p class="text-sm text-gray-400 mb-4">or click to browse files</p>
                                        <button type="button" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                            <i class="fas fa-folder-open mr-2"></i>Browse Files
                                        </button>
                                        <p class="text-xs text-gray-500 mt-2">Supports .js and .user.js files (max 5MB)</p>
                                    </div>
                                    <div id="uploadProgress" class="hidden">
                                        <i class="fas fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                                        <p class="text-sm">Uploading script...</p>
                                        <div class="w-full bg-white/10 rounded-full h-2 mt-2">
                                            <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div id="uploadSuccess" class="hidden">
                                        <i class="fas fa-check-circle text-2xl text-success mb-2"></i>
                                        <p class="text-sm font-medium" id="uploadedFileName">File uploaded successfully</p>
                                        <p class="text-xs text-gray-400" id="uploadedFileSize"></p>
                                    </div>
                                </div>
                                <input type="file" id="fileInput" accept=".js,.user.js" class="hidden">
                            </div>
                            
                            <!-- Script Metadata -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Script Name</label>
                                    <input type="text" id="scriptName" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Auto-detected from file">
                                    <p class="text-xs text-gray-400 mt-1">Will be auto-filled from uploaded file</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Version</label>
                                    <input type="text" id="scriptVersion" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Auto-detected from file">
                                    <p class="text-xs text-gray-400 mt-1">Will be auto-filled from @version tag</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <input type="text" id="scriptDescription" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Brief description of the script">
                            </div>
                            
                            <!-- Script Preview -->
                            <div class="mb-4" id="scriptPreviewContainer" style="display: none;">
                                <label class="block text-sm font-medium mb-2">Script Preview</label>
                                <div class="bg-white/5 border border-white/20 rounded-lg p-4 max-h-64 overflow-y-auto">
                                    <pre id="scriptPreview" class="text-sm font-mono text-gray-300 whitespace-pre-wrap"></pre>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">First 50 lines of your script</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Update Notes</label>
                                <textarea id="updateNotes" rows="3" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="What's new in this version?"></textarea>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="saveScriptBtn" class="bg-success hover:bg-success/80 text-white px-4 py-2 rounded-lg transition-colors" disabled>
                                    <i class="fas fa-save mr-2"></i>Save Script
                                </button>
                                <button id="cancelUploadBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-times mr-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Script List -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Uploaded Scripts</h3>
                            <button id="refreshScriptsBtn" class="bg-secondary hover:bg-secondary/80 text-white px-3 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        
                        <div id="scriptsList" class="space-y-4">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-code text-4xl mb-4"></i>
                                <p>Loading scripts...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Settings Section -->
                <div id="system-settings-section" class="content-section hidden">
                    <!-- Password Settings -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Password Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Admin Password</label>
                                    <div class="flex space-x-2">
                                        <input type="password" id="adminPasswordNew" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Enter new admin password">
                                        <button id="updateAdminPasswordBtn" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                            <i class="fas fa-key"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Current: manakamana12</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Site Password</label>
                                    <div class="flex space-x-2">
                                        <input type="password" id="sitePassword" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Enter new site password">
                                        <button id="updateSitePasswordBtn" class="bg-secondary hover:bg-secondary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                            <i class="fas fa-lock"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Current: ••••••••••</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">JWT Secret</label>
                                    <div class="flex space-x-2">
                                        <input type="password" id="jwtSecret" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="JWT secret key">
                                        <button id="generateJwtBtn" class="bg-accent hover:bg-accent/80 text-white px-4 py-2 rounded-lg transition-colors">
                                            <i class="fas fa-random"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Used for session tokens</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Session Timeout (hours)</label>
                                    <input type="number" id="sessionTimeout" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" value="24" min="1" max="168">
                                    <p class="text-xs text-gray-400 mt-1">How long admin sessions last</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Settings -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Database Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Supabase URL</label>
                                <input type="url" id="supabaseUrl" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="https://your-project.supabase.co">
                                <p class="text-xs text-gray-400 mt-1">Your Supabase project URL</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Service Role Key</label>
                                <input type="password" id="supabaseKey" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Service role key">
                                <p class="text-xs text-gray-400 mt-1">Supabase service role key</p>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex space-x-3">
                            <button id="testConnectionBtn" class="bg-success hover:bg-success/80 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plug mr-2"></i>Test Connection
                            </button>
                            <button id="saveDbSettingsBtn" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>Save Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold mb-4">Security Settings</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">Rate Limiting</h4>
                                    <p class="text-sm text-gray-400">Limit API requests per IP</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="rateLimitToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">Device Approval Required</h4>
                                    <p class="text-sm text-gray-400">New devices need admin approval</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="deviceApprovalToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">Encryption Enabled</h4>
                                    <p class="text-sm text-gray-400">Encrypt scripts with AES</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="encryptionToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications Section -->
                <div id="notifications-section" class="content-section hidden">
                    <!-- Tab Navigation -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex space-x-4 border-b border-white/10 pb-4">
                            <button id="notificationsTab" class="notification-tab active px-4 py-2 text-primary border-b-2 border-primary font-medium transition-colors">
                                <i class="fas fa-bell mr-2"></i>Notifications
                            </button>
                            <button id="paymentTab" class="notification-tab px-4 py-2 text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-400 transition-colors">
                                <i class="fas fa-credit-card mr-2"></i>Payment Setup
                            </button>
                        </div>
                    </div>

                    <!-- Notifications Content -->
                    <div id="notificationsContent" class="tab-content">
                    <!-- Email Configuration -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Email Configuration</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">EmailJS Service ID</label>
                                    <input type="text" id="emailjsServiceId" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="service_xxxxxxx">
                                    <p class="text-xs text-gray-400 mt-1">Your EmailJS service ID</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">EmailJS Template ID</label>
                                    <input type="text" id="emailjsTemplateId" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="template_xxxxxxx">
                                    <p class="text-xs text-gray-400 mt-1">Email template for notifications</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">EmailJS Public Key</label>
                                    <input type="text" id="emailjsPublicKey" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="user_xxxxxxxxxxxxxxx">
                                    <p class="text-xs text-gray-400 mt-1">Your EmailJS public key</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Admin Email</label>
                                    <input type="email" id="adminEmail" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="admin@example.com">
                                    <p class="text-xs text-gray-400 mt-1">Where to send notifications</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-4">
                            <button id="testEmailBtn" class="bg-success hover:bg-success/80 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-envelope mr-2"></i>Send Test Email
                            </button>
                            <button id="saveEmailConfigBtn" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>Save Configuration
                            </button>
                        </div>
                    </div>
                    
                    <!-- Notification Settings -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Notification Settings</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">New Device Registration</h4>
                                    <p class="text-sm text-gray-400">Email when new devices register</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifyNewDevice" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">Security Alerts</h4>
                                    <p class="text-sm text-gray-400">Email for security events</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifySecurityAlert" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">System Errors</h4>
                                    <p class="text-sm text-gray-400">Email for critical system errors</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifySystemError" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <h4 class="font-medium">Daily Summary</h4>
                                    <p class="text-sm text-gray-400">Daily activity summary email</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifyDailySummary" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Send Custom Notification -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold mb-4">Send Custom Notification</h3>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Recipient</label>
                                    <select id="notificationRecipient" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                                        <option value="admin">Admin Email</option>
                                        <option value="all_users">All Users</option>
                                        <option value="custom">Custom Email</option>
                                    </select>
                                </div>
                                
                                <div id="customEmailDiv" class="hidden">
                                    <label class="block text-sm font-medium mb-2">Custom Email</label>
                                    <input type="email" id="customEmail" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="user@example.com">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Subject</label>
                                <input type="text" id="notificationSubject" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Notification subject">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Message</label>
                                <textarea id="notificationMessage" rows="4" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Your notification message..."></textarea>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="sendNotificationBtn" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-paper-plane mr-2"></i>Send Notification
                                </button>
                                <button id="previewNotificationBtn" class="bg-secondary hover:bg-secondary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-eye mr-2"></i>Preview
                                </button>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Payment Setup Content -->
                    <div id="paymentContent" class="tab-content hidden">
                        <div class="glass rounded-xl p-6">
                            <div class="text-center py-8">
                                <i class="fas fa-credit-card text-4xl text-primary mb-4"></i>
                                <h3 class="text-xl font-semibold mb-2">Payment Setup</h3>
                                <p class="text-gray-400 mb-6">Configure your PayPal account and payment settings</p>
                                <a href="admin/payment-setup.html" target="_blank" class="bg-primary hover:bg-primary/80 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open Payment Setup
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Logs Section -->
                <div id="logs-section" class="content-section hidden">
                    <!-- Log Controls -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">System Logs</h3>
                            <div class="flex space-x-3">
                                <button id="refreshLogsBtn" class="bg-secondary hover:bg-secondary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                                </button>
                                <button id="exportLogsBtn" class="bg-accent hover:bg-accent/80 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-download mr-2"></i>Export
                                </button>
                                <button id="clearLogsBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-trash mr-2"></i>Clear Logs
                                </button>
                            </div>
                        </div>
                        
                        <!-- Log Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Log Type</label>
                                <select id="logTypeFilter" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                                    <option value="all">All Types</option>
                                    <option value="admin">Admin Actions</option>
                                    <option value="device">Device Events</option>
                                    <option value="security">Security</option>
                                    <option value="error">Errors</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Log Level</label>
                                <select id="logLevelFilter" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                                    <option value="all">All Levels</option>
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Date Range</label>
                                <select id="dateRangeFilter" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="all">All Time</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Search</label>
                                <input type="text" id="logSearch" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Search logs...">
                            </div>
                        </div>
                        
                        <!-- Custom Date Range (hidden by default) -->
                        <div id="customDateRange" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">From Date</label>
                                <input type="datetime-local" id="fromDate" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">To Date</label>
                                <input type="datetime-local" id="toDate" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="glass rounded-xl p-4">
                            <div class="text-center">
                                <p class="text-gray-400 text-sm">Total Logs</p>
                                <p id="totalLogsCount" class="text-xl font-bold">0</p>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-center">
                                <p class="text-gray-400 text-sm">Info</p>
                                <p id="infoLogsCount" class="text-xl font-bold text-blue-400">0</p>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-center">
                                <p class="text-gray-400 text-sm">Warnings</p>
                                <p id="warningLogsCount" class="text-xl font-bold text-warning">0</p>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-center">
                                <p class="text-gray-400 text-sm">Errors</p>
                                <p id="errorLogsCount" class="text-xl font-bold text-red-500">0</p>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4">
                            <div class="text-center">
                                <p class="text-gray-400 text-sm">Critical</p>
                                <p id="criticalLogsCount" class="text-xl font-bold text-red-600">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logs List -->
                    <div class="glass rounded-xl p-6">
                        <div id="logsList" class="space-y-2">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-file-alt text-4xl mb-4"></i>
                                <p>Loading logs...</p>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="logsPagination" class="flex items-center justify-between mt-6 pt-4 border-t border-white/10">
                            <div class="text-sm text-gray-400">
                                Showing <span id="logsShowing">0</span> of <span id="logsTotal">0</span> logs
                            </div>
                            <div class="flex space-x-2">
                                <button id="logsPrevBtn" class="bg-white/5 hover:bg-white/10 px-3 py-2 rounded-lg transition-colors" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="logsPageInfo" class="px-3 py-2 text-sm">Page 1 of 1</span>
                                <button id="logsNextBtn" class="bg-white/5 hover:bg-white/10 px-3 py-2 rounded-lg transition-colors" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Devices Section -->
                <div id="devices-section" class="content-section hidden">
                    <!-- Device Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Devices</p>
                                    <p id="totalDevicesCount" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-laptop text-primary"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Approved</p>
                                    <p id="approvedDevicesCount" class="text-2xl font-bold text-success">0</p>
                                </div>
                                <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Pending</p>
                                    <p id="pendingDevicesCount" class="text-2xl font-bold text-warning">0</p>
                                </div>
                                <div class="w-12 h-12 bg-warning/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-warning"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Blocked</p>
                                    <p id="blockedDevicesCount" class="text-2xl font-bold text-red-500">0</p>
                                </div>
                                <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-ban text-red-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Device Management Controls -->
                    <div class="glass rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Device Management</h3>
                            <div class="flex space-x-3">
                                <button id="refreshDevicesBtn" class="bg-secondary hover:bg-secondary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                                </button>
                                <button id="bulkApproveBtn" class="bg-success hover:bg-success/80 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-check-double mr-2"></i>Bulk Approve
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filter Tabs -->
                        <div class="flex space-x-2 mb-4">
                            <button class="device-filter-tab active bg-primary/20 text-primary px-4 py-2 rounded-lg transition-colors" data-filter="all">
                                All Devices
                            </button>
                            <button class="device-filter-tab bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg transition-colors" data-filter="pending">
                                Pending <span id="pendingBadge" class="ml-1 bg-warning text-white text-xs px-2 py-1 rounded-full">0</span>
                            </button>
                            <button class="device-filter-tab bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg transition-colors" data-filter="approved">
                                Approved
                            </button>
                            <button class="device-filter-tab bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg transition-colors" data-filter="blocked">
                                Blocked
                            </button>
                        </div>
                        
                        <!-- Search and Sort -->
                        <div class="flex space-x-4 mb-4">
                            <div class="flex-1">
                                <input type="text" id="deviceSearch" class="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary" placeholder="Search devices by username, device ID, or IP...">
                            </div>
                            <select id="deviceSort" class="bg-white/5 border border-white/20 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                                <option value="created_desc">Newest First</option>
                                <option value="created_asc">Oldest First</option>
                                <option value="username_asc">Username A-Z</option>
                                <option value="username_desc">Username Z-A</option>
                                <option value="last_active_desc">Recently Active</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Device List -->
                    <div class="glass rounded-xl p-6">
                        <div id="devicesList" class="space-y-4">
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-laptop text-4xl mb-4"></i>
                                <p>Loading devices...</p>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="devicesPagination" class="flex items-center justify-between mt-6 pt-4 border-t border-white/10">
                            <div class="text-sm text-gray-400">
                                Showing <span id="devicesShowing">0</span> of <span id="devicesTotal">0</span> devices
                            </div>
                            <div class="flex space-x-2">
                                <button id="devicesPrevBtn" class="bg-white/5 hover:bg-white/10 px-3 py-2 rounded-lg transition-colors" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="devicesPageInfo" class="px-3 py-2 text-sm">Page 1 of 1</span>
                                <button id="devicesNextBtn" class="bg-white/5 hover:bg-white/10 px-3 py-2 rounded-lg transition-colors" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let isLoggedIn = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check if user is already logged in
            const savedSession = localStorage.getItem('adminSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.expires > Date.now()) {
                    showAdminInterface();
                    return;
                }
            }
            
            // Show login screen
            showLoginScreen();
            
            // Initialize event listeners
            initializeEventListeners();
        }

        function initializeEventListeners() {
            // Login form - multiple event listeners for robustness
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                loginForm.onsubmit = handleLogin; // Fallback
            }
            
            if (loginBtn) {
                loginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleLogin(e);
                });
            }
            
            // Initialize navigation
            initNavigation();
            
            // Only initialize admin features if already logged in
            // Otherwise, they will be initialized after successful login
            
            // Initialize logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminInterface').classList.add('hidden');
        }

        function showAdminInterface() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminInterface').classList.remove('hidden');
            isLoggedIn = true;
            
            // Initialize all admin features after login
            initAdminFeatures();
            
            // Load dashboard data
            loadDashboardData();
            
            // Update last login time
            document.getElementById('lastLogin').textContent = new Date().toLocaleString();
        }

        async function handleLogin(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            console.log('Login attempt started');
            
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            if (!password) {
                showToast('Please enter admin password', 'error');
                return false;
            }
            
            // Show loading state
            loginBtnText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;
            
            try {
                console.log('Sending POST request to admin login');
                const response = await fetch('/.netlify/functions/adminLogin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    // Store session with consistent property names and longer duration
                    const session = {
                        token: result.token,
                        expires: Date.now() + (7 * 24 * 60 * 60 * 1000), // 7 days
                        expiry: Date.now() + (7 * 24 * 60 * 60 * 1000), // 7 days (backward compatibility)
                        loginTime: Date.now(),
                        lastActivity: Date.now()
                    };
                    localStorage.setItem('adminSession', JSON.stringify(session));
                    
                    showToast('Login successful!', 'success');
                    showAdminInterface();
                } else {
                    showToast(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed. Please try again.', 'error');
            } finally {
                // Reset button state
                loginBtnText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
            
            return false;
        }

        function initNavigation() {
            // Navigation click handlers
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', handleNavigation);
            });
        }
        
        function handleNavigation(e) {
            e.preventDefault();
            
            const target = e.currentTarget.getAttribute('href').substring(1);
            
            // Update active nav item
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active', 'bg-white/20');
            });
            e.currentTarget.classList.add('active', 'bg-white/20');
            
            // Show target section
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            const targetSection = document.getElementById(target + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'script-management': 'Script Management',
                'system-settings': 'System Settings',
                'notifications': 'Notifications',
                'logs': 'System Logs',
                'devices': 'Device Management'
            };
            
            document.getElementById('pageTitle').textContent = titles[target] || 'Dashboard';
        }

        function updatePageTitle(section) {
            const titles = {
                'dashboard': { title: 'Dashboard', subtitle: 'System overview and statistics' },
                'script-management': { title: 'Script Management', subtitle: 'Upload and manage LMS AI scripts' },
                'system-settings': { title: 'System Settings', subtitle: 'Configure passwords and security' },
                'notifications': { title: 'Notifications', subtitle: 'Configure EmailJS and alerts' },
                'logs': { title: 'System Logs', subtitle: 'View admin actions and device logs' },
                'devices': { title: 'Device Management', subtitle: 'Manage registered devices' }
            };
            
            const pageInfo = titles[section] || titles['dashboard'];
            document.getElementById('pageTitle').textContent = pageInfo.title;
            document.getElementById('pageSubtitle').textContent = pageInfo.subtitle;
        }

        function handleLogout() {
            localStorage.removeItem('adminSession');
            isLoggedIn = false;
            currentUser = null;
            showLoginScreen();
            showToast('Logged out successfully', 'info');
        }

        // Throttle dashboard loading to prevent memory leak
        let dashboardLoadInProgress = false;
        let lastDashboardLoad = 0;
        const DASHBOARD_THROTTLE_MS = 2000; // 2 seconds minimum between loads (reduced from 5s)
        
        async function loadDashboardData() {
            // Prevent repeated calls
            const now = Date.now();
            if (dashboardLoadInProgress || (now - lastDashboardLoad) < DASHBOARD_THROTTLE_MS) {
                console.log('Dashboard load throttled - too many requests');
                return;
            }
            
            dashboardLoadInProgress = true;
            lastDashboardLoad = now;
            
            try {
                // Get admin session token
                const savedSession = localStorage.getItem('adminSession');
                if (!savedSession) {
                    showToast('Session expired, please login again', 'error');
                    showLoginScreen();
                    return;
                }
                
                const session = JSON.parse(savedSession);
                if (session.expires < Date.now()) {
                    showToast('Session expired, please login again', 'error');
                    showLoginScreen();
                    return;
                }
                
                console.log('Using admin token:', session.token.substring(0, 20) + '...');
                
                const response = await fetch('/.netlify/functions/getDashboardData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: session.token })
                });
                
                const data = await response.json();
                
                if (data.success && data.dashboard) {
                    updateDashboardStats(data.dashboard.stats);
                    updateRecentActivity(data.dashboard.recentLogs);
                    // Load user token usage table (ONCE per page load to prevent lag)
                    loadUserTokenUsage();
                } else {
                    console.error('Dashboard data error:', data.message);
                    showToast(data.message || 'Failed to load dashboard data', 'error');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Failed to load dashboard data', 'error');
            } finally {
                dashboardLoadInProgress = false;
            }
        }

        function updateDashboardStats(stats) {
            if (!stats) {
                console.warn('No stats provided to updateDashboardStats');
                return;
            }
            
            // Safely update each element with null checks
            const activeDevicesEl = document.getElementById('activeDevicesCount');
            if (activeDevicesEl) {
                activeDevicesEl.textContent = stats.activeDevices || 0;
            }
            
            const currentVersionEl = document.getElementById('currentVersion');
            if (currentVersionEl) {
                currentVersionEl.textContent = stats.currentVersion || 'v1.0.0';
            }
            
            const systemStatusEl = document.getElementById('systemStatus');
            if (systemStatusEl) {
                systemStatusEl.textContent = stats.systemStatus || 'Online';
            }
            
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = stats.lastUpdate || 'Today';
            }
            
            console.log('Dashboard stats updated successfully:', stats);
        }

        function updateDeviceChart(deviceActivity) {
            const chartElement = document.getElementById('deviceChart');
            if (!chartElement) {
                console.warn('Device chart element not found, skipping chart update');
                return;
            }
            
            // Destroy existing chart FIRST
            if (window.deviceChart && typeof window.deviceChart.destroy === 'function') {
                window.deviceChart.destroy();
                window.deviceChart = null;
            }
            
            // CRITICAL: Reset canvas dimensions to prevent accumulation
            chartElement.width = 400;
            chartElement.height = 200;
            chartElement.style.width = '400px';
            chartElement.style.height = '200px';
            
            const ctx = chartElement.getContext('2d');
            if (!ctx) {
                console.warn('Failed to get 2d context for device chart');
                return;
            }
            
            // Create new chart and store reference
            window.deviceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Devices',
                        data: deviceActivity || [12, 19, 3, 5, 2, 3, 9],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            
            if (activities && activities.length > 0) {
                container.innerHTML = activities.map(activity => `
                    <div class="flex items-center space-x-3 p-3 bg-white/5 rounded-lg">
                        <div class="w-8 h-8 bg-${activity.type === 'success' ? 'success' : 'primary'}/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-${activity.icon || 'info'} text-${activity.type === 'success' ? 'success' : 'primary'} text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${activity.message}</p>
                            <p class="text-xs text-gray-400">${activity.time}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white/80 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // Prevent unauthorized access
        window.addEventListener('beforeunload', function() {
            if (!isLoggedIn) {
                localStorage.removeItem('adminSession');
            }
        });
        
        // ===== SESSION MANAGEMENT FUNCTIONS =====
        
        function updateSessionActivity() {
            const session = localStorage.getItem('adminSession');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    const now = Date.now();
                    
                    // Update last activity
                    sessionData.lastActivity = now;
                    
                    // Auto-extend session if it's within 24 hours of expiry
                    const sessionExpiry = sessionData.expires || sessionData.expiry;
                    if (sessionExpiry - now < (24 * 60 * 60 * 1000)) {
                        sessionData.expires = now + (7 * 24 * 60 * 60 * 1000);
                        sessionData.expiry = now + (7 * 24 * 60 * 60 * 1000);
                        console.log('Session auto-extended');
                    }
                    
                    localStorage.setItem('adminSession', JSON.stringify(sessionData));
                } catch (error) {
                    console.error('Session update error:', error);
                }
            }
        }
        
        function getValidSession() {
            const session = localStorage.getItem('adminSession');
            if (!session) return null;
            
            try {
                const sessionData = JSON.parse(session);
                const now = Date.now();
                const sessionExpiry = sessionData.expires || sessionData.expiry;
                
                if (sessionData.token && sessionExpiry > now) {
                    // Update activity on each valid session check
                    updateSessionActivity();
                    return sessionData;
                } else {
                    localStorage.removeItem('adminSession');
                    return null;
                }
            } catch (error) {
                console.error('Session validation error:', error);
                localStorage.removeItem('adminSession');
                return null;
            }
        }

        // ===== SCRIPT MANAGEMENT FUNCTIONS =====
        
        function initScriptManagement() {
            // Upload script button
            document.getElementById('uploadScriptBtn')?.addEventListener('click', () => {
                const form = document.getElementById('uploadForm');
                form.classList.toggle('hidden');
            });
            
            // Cancel upload
            document.getElementById('cancelUploadBtn')?.addEventListener('click', () => {
                document.getElementById('uploadForm').classList.add('hidden');
                clearScriptForm();
            });
            
            // Save script
            document.getElementById('saveScriptBtn')?.addEventListener('click', saveScript);
            
            // Refresh scripts
            document.getElementById('refreshScriptsBtn')?.addEventListener('click', loadScripts);
            
            // Load scripts on init
            loadScripts();
        }
        
        function clearScriptForm() {
            document.getElementById('scriptName').value = '';
            document.getElementById('scriptVersion').value = '';
            document.getElementById('scriptDescription').value = '';
            document.getElementById('scriptContent').value = '';
            document.getElementById('updateNotes').value = '';
        }
        
        async function saveScript() {
            const name = document.getElementById('scriptName').value;
            const version = document.getElementById('scriptVersion').value;
            const description = document.getElementById('scriptDescription').value;
            const content = document.getElementById('scriptContent').value;
            const updateNotes = document.getElementById('updateNotes').value;
            
            if (!name || !version || !content) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'uploadScript',
                        token: session.token,
                        name,
                        version,
                        description,
                        content,
                        updateNotes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Script uploaded successfully!', 'success');
                    document.getElementById('uploadForm').classList.add('hidden');
                    clearScriptForm();
                    loadScripts();
                } else {
                    showToast(result.message || 'Failed to upload script', 'error');
                }
            } catch (error) {
                console.error('Script upload error:', error);
                showToast('Failed to upload script', 'error');
            }
        }
        
        async function loadScripts() {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'listScripts',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayScripts(result.scripts);
                } else {
                    showToast('Failed to load scripts', 'error');
                }
            } catch (error) {
                console.error('Load scripts error:', error);
                showToast('Failed to load scripts', 'error');
            }
        }
        
        function displayScripts(scripts) {
            const container = document.getElementById('scriptsList');
            
            if (!scripts || scripts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-code text-4xl mb-4"></i>
                        <p>No scripts uploaded yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = scripts.map(script => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-primary/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-code text-primary"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold">${script.name}</h4>
                                <p class="text-sm text-gray-400">v${script.version}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${script.is_active ? '<span class="bg-success/20 text-success px-2 py-1 rounded text-xs">Active</span>' : ''}
                            <button onclick="viewScript(${script.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                            <button onclick="setActiveScript(${script.id})" class="bg-success hover:bg-success/80 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-check mr-1"></i>Activate
                            </button>
                            <button onclick="deleteScript(${script.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-300 mb-2">${script.description || 'No description'}</p>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>Size: ${(script.file_size / 1024).toFixed(1)} KB</span>
                        <span>Downloads: ${script.downloads || 0}</span>
                        <span>Created: ${new Date(script.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function setActiveScript(scriptId) {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'setActiveScript',
                        token: session.token,
                        scriptId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Script activated successfully!', 'success');
                    loadScripts();
                } else {
                    showToast(result.message || 'Failed to activate script', 'error');
                }
            } catch (error) {
                console.error('Activate script error:', error);
                showToast('Failed to activate script', 'error');
            }
        }
        
        async function viewScript(scriptId) {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getScript',
                        token: session.token,
                        scriptId
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.script) {
                    // Create a modal to display script content
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-slate-800 rounded-xl p-6 max-w-4xl max-h-[80vh] overflow-auto m-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold">${result.script.version} - ${result.script.update_notes || 'No description'}</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-4">
                                <pre class="text-sm text-green-400 whitespace-pre-wrap overflow-x-auto">${result.script.encrypted_script}</pre>
                            </div>
                            <div class="mt-4 text-sm text-gray-400">
                                <p>Created: ${new Date(result.script.created_at).toLocaleString()}</p>
                                <p>Size: ${(result.script.file_size / 1024).toFixed(1)} KB</p>
                                <p>Active: ${result.script.is_active ? 'Yes' : 'No'}</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    showToast(result.message || 'Failed to load script', 'error');
                }
            } catch (error) {
                console.error('View script error:', error);
                showToast('Failed to view script', 'error');
            }
        }
        
        async function deleteScript(scriptId) {
            if (!confirm('Are you sure you want to delete this script?')) return;
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteScript',
                        token: session.token,
                        scriptId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Script deleted successfully!', 'success');
                    loadScripts();
                } else {
                    showToast(result.message || 'Failed to delete script', 'error');
                }
            } catch (error) {
                console.error('Delete script error:', error);
                showToast('Failed to delete script', 'error');
            }
        }
        
        // ===== DEVICE MANAGEMENT FUNCTIONS =====
        
        function initDeviceManagement() {
            // Filter tabs
            document.querySelectorAll('.device-filter-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.device-filter-tab').forEach(t => {
                        t.classList.remove('active', 'bg-primary/20', 'text-primary');
                        t.classList.add('bg-white/5', 'hover:bg-white/10');
                    });
                    e.target.classList.add('active', 'bg-primary/20', 'text-primary');
                    e.target.classList.remove('bg-white/5', 'hover:bg-white/10');
                    
                    loadDevices(e.target.dataset.filter);
                });
            });
            
            // Refresh devices
            document.getElementById('refreshDevicesBtn')?.addEventListener('click', () => loadDevices());
            
            // Bulk approve
            document.getElementById('bulkApproveBtn')?.addEventListener('click', bulkApproveDevices);
            
            // Search and sort
            document.getElementById('deviceSearch')?.addEventListener('input', debounce(loadDevices, 500));
            document.getElementById('deviceSort')?.addEventListener('change', loadDevices);
            
            // Load devices on init
            loadDevices();
        }
        
        async function loadDevices(filter = 'all') {
            const container = document.getElementById('devicesList');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-laptop text-4xl mb-4"></i>
                    <p>Loading devices...</p>
                </div>
            `;
            
            try {
                const session = getValidSession();
                if (!session || !session.token) {
                    console.error('No admin session found or token missing');
                    showToast('Session expired, please login again', 'error');
                    showLoginScreen();
                    return;
                }
                
                console.log('Using admin token:', session.token.substring(0, 20) + '...');
                
                const search = document.getElementById('deviceSearch')?.value || '';
                const sort = document.getElementById('deviceSort')?.value || 'created_desc';
                
                const response = await fetch('/.netlify/functions/deviceManagement', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        action: 'listDevices',
                        token: session.token,
                        filter,
                        search,
                        sort
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayDevices(result.devices, filter);
                    updateDeviceStats(result.stats);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Failed to load devices: ${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load devices error:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading devices</p>
                    </div>
                `;
            }
        }
        
function displayDevices(devices, filter = 'all') {
    const container = document.getElementById('devicesList');
    
    let filteredDevices = devices;
    if (filter !== 'all') {
        filteredDevices = devices.filter(device => device.status === filter);
    }
    
    if (filteredDevices.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-400">
                <i class="fas fa-laptop text-4xl mb-4"></i>
                <p>No devices found</p>
            </div>
        `;
        return;
    }
            
    container.innerHTML = filteredDevices.map(device => {
        const statusClass = device.status === 'active' ? 'bg-success/20 text-success' :
                           device.status === 'pending' ? 'bg-warning/20 text-warning' :
                           'bg-red-500/20 text-red-500';
        
        // Safely escape device ID for onclick handlers
        const deviceId = device.id ? String(device.id).replace(/["'\\]/g, '') : 'unknown';
        
        const approveButton = device.status === 'pending' ? 
            `<button onclick="approveDevice('${deviceId}')" class="bg-success hover:bg-success/80 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-check mr-1"></i>Approve
            </button>` : '';
        
        return `
        <div class="bg-white/5 rounded-lg p-4 border border-white/10">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-laptop text-primary"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold">${(device.username || 'Unknown User').replace(/[<>"'&]/g, '')}</h4>
                        <p class="text-sm text-gray-400">${(device.device_name || device.hwid || 'Unknown Device').replace(/[<>"'&]/g, '')}</p>
                        <p class="text-xs text-gray-500">Status: ${device.status}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="px-3 py-1 rounded-full text-xs ${statusClass}">
                        ${device.status.charAt(0).toUpperCase() + device.status.slice(1)}
                    </span>
                    ${approveButton}
                    <button onclick="deleteDevice('${deviceId}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                    <button onclick="blockDevice('${deviceId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-ban mr-1"></i>Block
                    </button>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-400">
                <p>Last Active: ${device.created_at ? new Date(device.created_at).toLocaleString() : 'Unknown'}</p>
                <p class="truncate">HWID: ${(device.hwid || 'N/A').replace(/[<>"'&]/g, '')}</p>
            </div>
        </div>
        `;
    }).join('');
}

function updateDeviceStats(stats) {
    // Use backend stats if available, otherwise calculate from devices
    if (stats && typeof stats === 'object') {
        document.getElementById('totalDevicesCount').textContent = stats.total || 0;
        document.getElementById('approvedDevicesCount').textContent = stats.approved || 0;
        document.getElementById('pendingDevicesCount').textContent = stats.pending || 0;
        document.getElementById('blockedDevicesCount').textContent = stats.blocked || 0;
        document.getElementById('pendingBadge').textContent = stats.pending || 0;
    } else {
        // Fallback for array input (legacy support)
        const devices = stats;
        const total = devices.length;
        const approved = devices.filter(d => d.status === 'approved').length;
        const pending = devices.filter(d => d.status === 'pending').length;
        const blocked = devices.filter(d => d.status === 'blocked').length;
        
        document.getElementById('totalDevicesCount').textContent = total;
        document.getElementById('approvedDevicesCount').textContent = approved;
        document.getElementById('pendingDevicesCount').textContent = pending;
        document.getElementById('blockedDevicesCount').textContent = blocked;
        document.getElementById('pendingBadge').textContent = pending;
    }
}
// Device action functions
async function approveDevice(deviceId) {
    try {
        const session = JSON.parse(localStorage.getItem('adminSession'));
        const response = await fetch('/.netlify/functions/deviceManagement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'approveDevice',
                token: session.token,
                deviceId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Device approved successfully!', 'success');
            
            // Switch to approved tab to show the newly approved device
            const approvedTab = document.querySelector('[data-filter="approved"]');
            if (approvedTab) {
                // Update tab appearance
                document.querySelectorAll('.device-filter-tab').forEach(tab => {
                    tab.classList.remove('active', 'bg-primary/20', 'text-primary');
                    tab.classList.add('bg-white/5', 'hover:bg-white/10');
                });
                approvedTab.classList.add('active', 'bg-primary/20', 'text-primary');
                approvedTab.classList.remove('bg-white/5', 'hover:bg-white/10');
                
                // Load approved devices
                loadDevices('approved');
            } else {
                // Fallback: reload all devices
                loadDevices();
            }
        } else {
            showToast(result.message || 'Failed to approve device', 'error');
        }
    } catch (error) {
        console.error('Approve device error:', error);
        showToast('Failed to approve device', 'error');
    }
}

async function blockDevice(deviceId) {
    if (!confirm('Are you sure you want to block this device?')) return;
    
    try {
        const session = JSON.parse(localStorage.getItem('adminSession'));
        const response = await fetch('/.netlify/functions/deviceManagement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'blockDevice',
                token: session.token,
                deviceId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Device blocked successfully!', 'success');
            loadDevices(); // Reload devices
        } else {
            showToast(result.message || 'Failed to block device', 'error');
        }
    } catch (error) {
        console.error('Block device error:', error);
        showToast('Failed to block device', 'error');
    }
}

async function deleteDevice(deviceId) {
    if (!confirm('Are you sure you want to delete this device? This action cannot be undone.')) return;
    
    try {
        const session = JSON.parse(localStorage.getItem('adminSession'));
        const response = await fetch('/.netlify/functions/deviceManagement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'deleteDevice',
                token: session.token,
                deviceId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Device deleted successfully!', 'success');
            loadDevices(); // Reload devices
        } else {
            showToast(result.message || 'Failed to delete device', 'error');
        }
    } catch (error) {
        console.error('Delete device error:', error);
        showToast('Failed to delete device', 'error');
    }
}
async function bulkApproveDevices() {
    if (!confirm('Are you sure you want to approve all pending devices?')) return;
    
    try {
        const session = JSON.parse(localStorage.getItem('adminSession'));
        const response = await fetch('/.netlify/functions/deviceManagement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'bulkApprove',
                token: session.token
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            loadDevices(); // Reload devices
        } else {
            showToast(result.message || 'Failed to approve devices', 'error');
        }
    } catch (error) {
        console.error('Bulk approve error:', error);
        showToast('Failed to approve devices', 'error');
    }
}

// ===== LOGS MANAGEMENT FUNCTIONS =====

function initLogsManagement() {
    // Filter controls
    document.getElementById('logTypeFilter')?.addEventListener('change', loadLogs);
    document.getElementById('logLevelFilter')?.addEventListener('change', loadLogs);
    document.getElementById('dateRangeFilter')?.addEventListener('change', handleDateRangeChange);
    document.getElementById('logSearch')?.addEventListener('input', debounce(loadLogs, 500));
    
    // Action buttons
    document.getElementById('refreshLogsBtn')?.addEventListener('click', loadLogs);
    document.getElementById('exportLogsBtn')?.addEventListener('click', exportLogs);
    document.getElementById('clearLogsBtn')?.addEventListener('click', clearLogs);
    
    // Load logs on init
    loadLogs();
}
        
        function handleDateRangeChange() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            const customRange = document.getElementById('customDateRange');
            
            if (dateRange === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
                loadLogs();
            }
        }
        
        async function loadLogs() {
            try {
                const container = document.getElementById('logsList');
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <p>Loading logs...</p>
                    </div>
                `;
                
                const response = await fetch('/.netlify/functions/logsManagement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getLogs',
                        token: localStorage.getItem('adminToken'),
                        logType: document.getElementById('logTypeFilter')?.value || 'all',
                        level: document.getElementById('logLevelFilter')?.value || 'all',
                        limit: 50,
                        offset: 0
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayLogs(data.logs);
                    updateLogStats(data.logs);
                    showToast('Logs loaded successfully', 'success');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                showToast('Failed to load logs: ' + error.message, 'error');
                
                // Show error state
                const container = document.getElementById('logsList');
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4 text-red-400"></i>
                        <p>Failed to load logs</p>
                        <button onclick="loadLogs()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function displayLogs(logs) {
            const container = document.getElementById('logsList');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-file-alt text-4xl mb-4"></i>
                        <p>No logs found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="flex items-start space-x-3 p-3 bg-white/5 rounded-lg border border-white/10">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${
                        log.level === 'error' || log.level === 'critical' ? 'bg-red-500/20' :
                        log.level === 'warning' ? 'bg-warning/20' :
                        'bg-blue-500/20'
                    }">
                        <i class="fas fa-${
                            log.level === 'error' || log.level === 'critical' ? 'exclamation-triangle' :
                            log.level === 'warning' ? 'exclamation' :
                            'info'
                        } text-${
                            log.level === 'error' || log.level === 'critical' ? 'red-500' :
                            log.level === 'warning' ? 'warning' :
                            'blue-400'
                        } text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium">${log.message}</span>
                            <span class="text-xs text-gray-400">${new Date(log.created_at).toLocaleString()}</span>
                        </div>
                        <div class="flex items-center space-x-4 text-xs text-gray-400">
                            <span class="px-2 py-1 bg-white/10 rounded">${log.log_type}</span>
                            <span class="px-2 py-1 bg-white/10 rounded">${log.level}</span>
                            ${log.details ? `<span class="text-gray-500">${JSON.stringify(log.details)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateLogStats(logs) {
            const total = logs.length;
            const info = logs.filter(l => l.level === 'info').length;
            const warning = logs.filter(l => l.level === 'warning').length;
            const error = logs.filter(l => l.level === 'error').length;
            const critical = logs.filter(l => l.level === 'critical').length;
            
            document.getElementById('totalLogsCount').textContent = total;
            document.getElementById('infoLogsCount').textContent = info;
            document.getElementById('warningLogsCount').textContent = warning;
            document.getElementById('errorLogsCount').textContent = error;
            document.getElementById('criticalLogsCount').textContent = critical;
        }
        
        async function exportLogs() {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session) {
                    showToast('Session expired, please login again', 'error');
                    return;
                }
                
                showToast('Exporting logs...', 'info');
                
                const response = await fetch('/.netlify/functions/logsManagement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'exportLogs',
                        token: session.token
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logs-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('Logs exported successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.message || 'Failed to export logs', 'error');
                }
            } catch (error) {
                console.error('Export logs error:', error);
                showToast('Failed to export logs', 'error');
            }
        }
        
        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session) {
                    showToast('Session expired, please login again', 'error');
                    return;
                }
                
                showToast('Clearing logs...', 'info');
                
                const response = await fetch('/.netlify/functions/logsManagement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'clearLogs',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Logs cleared successfully!', 'success');
                    loadLogs(); // Reload logs
                } else {
                    showToast(result.message || 'Failed to clear logs', 'error');
                }
            } catch (error) {
                console.error('Clear logs error:', error);
                showToast('Failed to clear logs', 'error');
            }
        }
        // ===== NOTIFICATIONS FUNCTIONS =====

// Initialize notification tabs
function initNotificationTabs() {
    const notificationsTab = document.getElementById('notificationsTab');
    const paymentTab = document.getElementById('paymentTab');

    if (notificationsTab && paymentTab) {
        notificationsTab.addEventListener('click', () => switchNotificationTab('notifications'));
        paymentTab.addEventListener('click', () => switchNotificationTab('payment'));
    }
}

function switchNotificationTab(tab) {
    const notificationsTab = document.getElementById('notificationsTab');
    const paymentTab = document.getElementById('paymentTab');
    const notificationsContent = document.getElementById('notificationsContent');
    const paymentContent = document.getElementById('paymentContent');

    // Reset all tabs
    document.querySelectorAll('.notification-tab').forEach(t => {
        t.classList.remove('active', 'text-primary', 'border-primary');
        t.classList.add('text-gray-400', 'border-transparent');
    });

    // Hide all content
    document.querySelectorAll('.tab-content').forEach(c => {
        c.classList.add('hidden');
    });

    // Show selected tab and content
    if (tab === 'notifications') {
        notificationsTab.classList.add('active', 'text-primary', 'border-primary');
        notificationsTab.classList.remove('text-gray-400', 'border-transparent');
        notificationsContent.classList.remove('hidden');
    } else if (tab === 'payment') {
        paymentTab.classList.add('active', 'text-primary', 'border-primary');
        paymentTab.classList.remove('text-gray-400', 'border-transparent');
        paymentContent.classList.remove('hidden');
    }
}
        
        function initNotifications() {
    // Initialize notification tabs
    initNotificationTabs();
    
    // Email configuration
            document.getElementById('testEmailBtn')?.addEventListener('click', testEmail);
            document.getElementById('saveEmailConfigBtn')?.addEventListener('click', saveEmailConfig);
            
            // Custom notification
            document.getElementById('notificationRecipient')?.addEventListener('change', handleRecipientChange);
            document.getElementById('sendNotificationBtn')?.addEventListener('click', sendNotification);
            document.getElementById('previewNotificationBtn')?.addEventListener('click', previewNotification);
        }
        
        function handleRecipientChange() {
            const recipient = document.getElementById('notificationRecipient').value;
            const customEmailDiv = document.getElementById('customEmailDiv');
            
            if (recipient === 'custom') {
                customEmailDiv.classList.remove('hidden');
            } else {
                customEmailDiv.classList.add('hidden');
            }
        }
        
        async function testEmail() {
            showToast('Sending test email...', 'info');
            
            // Simulate email sending
            setTimeout(() => {
                showToast('Test email sent successfully!', 'success');
            }, 2000);
        }
        
        async function saveEmailConfig() {
            const serviceId = document.getElementById('emailjsServiceId').value;
            const templateId = document.getElementById('emailjsTemplateId').value;
            const publicKey = document.getElementById('emailjsPublicKey').value;
            const adminEmail = document.getElementById('adminEmail').value;
            
            if (!serviceId || !templateId || !publicKey || !adminEmail) {
                showToast('Please fill in all email configuration fields', 'error');
                return;
            }
            
            showToast('Email configuration saved successfully!', 'success');
        }
        
        async function sendNotification() {
            const recipient = document.getElementById('notificationRecipient').value;
            const subject = document.getElementById('notificationSubject').value;
            const message = document.getElementById('notificationMessage').value;
            
            if (!subject || !message) {
                showToast('Please fill in subject and message', 'error');
                return;
            }
            
            showToast('Sending notification...', 'info');
            
            // Simulate notification sending
            setTimeout(() => {
                showToast('Notification sent successfully!', 'success');
                document.getElementById('notificationSubject').value = '';
                document.getElementById('notificationMessage').value = '';
            }, 2000);
        }
        
        function previewNotification() {
            const recipient = document.getElementById('notificationRecipient').value;
            const subject = document.getElementById('notificationSubject').value;
            const message = document.getElementById('notificationMessage').value;
            
            if (!subject || !message) {
                showToast('Please fill in subject and message to preview', 'error');
                return;
            }
            
            // Create a modal to preview the notification
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-xl p-6 max-w-2xl max-h-[80vh] overflow-auto m-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold">Notification Preview</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-4 border border-white/10">
                        <div class="mb-3">
                            <span class="text-sm text-gray-400">To:</span>
                            <span class="ml-2 text-white">${recipient === 'custom' ? document.getElementById('customEmail').value || 'Custom Email' : recipient.replace('_', ' ').toUpperCase()}</span>
                        </div>
                        <div class="mb-3">
                            <span class="text-sm text-gray-400">Subject:</span>
                            <span class="ml-2 text-white font-medium">${subject}</span>
                        </div>
                        <div class="border-t border-white/10 pt-3">
                            <div class="text-sm text-gray-400 mb-2">Message:</div>
                            <div class="text-white whitespace-pre-wrap">${message}</div>
                        </div>
                    </div>
                    <div class="mt-4 text-xs text-gray-400">
                        <p>This is a preview of how the notification will appear to recipients.</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ===== UTILITY FUNCTIONS =====
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ===== SYSTEM SETTINGS FUNCTIONS =====
        
        function initSystemSettings() {
            // Password update buttons
            document.getElementById('updateAdminPasswordBtn')?.addEventListener('click', updateAdminPassword);
            document.getElementById('updateSitePasswordBtn')?.addEventListener('click', updateSitePassword);
            document.getElementById('generateJwtBtn')?.addEventListener('click', generateJwtSecret);
            
            // Database settings
            document.getElementById('testConnectionBtn')?.addEventListener('click', testDatabaseConnection);
            document.getElementById('saveDbSettingsBtn')?.addEventListener('click', saveDatabaseSettings);
            
            // Load current settings
            loadSystemSettings();
        }
        
        async function updateAdminPassword() {
            const newPassword = document.getElementById('adminPasswordNew').value;
            
            if (!newPassword || newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/systemSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateAdminPassword',
                        token: session.token,
                        newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Admin password updated successfully!', 'success');
                    document.getElementById('adminPasswordNew').value = '';
                } else {
                    showToast(result.message || 'Failed to update password', 'error');
                }
            } catch (error) {
                console.error('Update admin password error:', error);
                showToast('Failed to update password', 'error');
            }
        }
        
        async function updateSitePassword() {
            const sitePassword = document.getElementById('sitePassword').value;
            
            if (!sitePassword || sitePassword.length < 3) {
                showToast('Site password must be at least 3 characters', 'error');
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/systemSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSitePassword',
                        token: session.token,
                        sitePassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Site password updated successfully!', 'success');
                    document.getElementById('sitePassword').value = '';
                } else {
                    showToast(result.message || 'Failed to update site password', 'error');
                }
            } catch (error) {
                console.error('Update site password error:', error);
                showToast('Failed to update site password', 'error');
            }
        }
        
        async function generateJwtSecret() {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/systemSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateJwtSecret',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('jwtSecret').value = result.secret;
                    showToast('JWT secret generated successfully!', 'success');
                } else {
                    showToast(result.message || 'Failed to generate JWT secret', 'error');
                }
            } catch (error) {
                console.error('Generate JWT secret error:', error);
                showToast('Failed to generate JWT secret', 'error');
            }
        }
        
        async function testDatabaseConnection() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            
            if (!supabaseUrl || !supabaseKey) {
                showToast('Please enter both Supabase URL and key', 'error');
                return;
            }
            
            showToast('Testing database connection...', 'info');
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/systemSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'testDatabaseConnection',
                        token: session.token,
                        supabaseUrl,
                        supabaseKey
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Database connection successful!', 'success');
                } else {
                    showToast(result.message || 'Database connection failed', 'error');
                }
            } catch (error) {
                console.error('Test database connection error:', error);
                showToast('Failed to test database connection', 'error');
            }
        }
        
        async function saveDatabaseSettings() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            
            if (!supabaseUrl || !supabaseKey) {
                showToast('Please enter both Supabase URL and key', 'error');
                return;
            }
            
            showToast('Database settings saved! (Note: Requires server restart)', 'success');
        }
        
        async function loadSystemSettings() {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/systemSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSystemInfo',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update system info display if needed
                    console.log('System info loaded:', result.systemInfo);
                }
            } catch (error) {
                console.error('Load system settings error:', error);
            }
        }
        
        // ===== SCRIPT MANAGEMENT FUNCTIONS =====
        
        function initScriptManagement() {
            // Upload script button
            document.getElementById('uploadScriptBtn')?.addEventListener('click', toggleUploadForm);
            
            // Cancel upload
            document.getElementById('cancelUploadBtn')?.addEventListener('click', cancelUpload);
            
            // Save script button
            document.getElementById('saveScriptBtn')?.addEventListener('click', saveUploadedScript);
            
            // File upload area
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (fileUploadArea && fileInput) {
                // Click to browse files
                fileUploadArea.addEventListener('click', () => fileInput.click());
                
                // File input change
                fileInput.addEventListener('change', handleFileSelect);
                
                // Drag and drop events
                fileUploadArea.addEventListener('dragover', handleDragOver);
                fileUploadArea.addEventListener('dragleave', handleDragLeave);
                fileUploadArea.addEventListener('drop', handleFileDrop);
            }
            
            // Refresh scripts
            document.getElementById('refreshScriptsBtn')?.addEventListener('click', loadScripts);
            
            // Load scripts on init
            loadScripts();
        }
        
        function toggleUploadForm() {
            const uploadForm = document.getElementById('uploadForm');
            const isHidden = uploadForm.classList.contains('hidden');
            
            if (isHidden) {
                uploadForm.classList.remove('hidden');
                resetUploadForm();
            } else {
                uploadForm.classList.add('hidden');
            }
        }
        
        function cancelUpload() {
            document.getElementById('uploadForm').classList.add('hidden');
            resetUploadForm();
        }
        
        function resetUploadForm() {
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Reset form fields
            document.getElementById('scriptName').value = '';
            document.getElementById('scriptVersion').value = '';
            document.getElementById('scriptDescription').value = '';
            document.getElementById('updateNotes').value = '';
            
            // Reset upload area
            showUploadPlaceholder();
            
            // Hide script preview
            document.getElementById('scriptPreviewContainer').style.display = 'none';
            
            // Disable save button
            document.getElementById('saveScriptBtn').disabled = true;
            
            // Clear stored script content
            window.uploadedScriptContent = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('border-primary/50');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('border-primary/50');
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('border-primary/50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function processFile(file) {
            // Validate file type
            const allowedExtensions = ['.js', '.user.js'];
            const fileName = file.name.toLowerCase();
            const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension) {
                showToast('Invalid file type. Only .js and .user.js files are allowed.', 'error');
                return;
            }
            
            // Validate file size (5MB max)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('File too large. Maximum size is 5MB.', 'error');
                return;
            }
            
            // Show upload progress
            showUploadProgress();
            
            // Read file content
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                // Store script content
                window.uploadedScriptContent = content;
                
                // Extract metadata from script
                const metadata = extractScriptMetadata(content, file.name);
                
                // Fill form fields
                document.getElementById('scriptName').value = metadata.name;
                document.getElementById('scriptVersion').value = metadata.version;
                
                // Show success state
                showUploadSuccess(file.name, file.size);
                
                // Show script preview
                showScriptPreview(content);
                
                // Enable save button
                document.getElementById('saveScriptBtn').disabled = false;
            };
            
            reader.onerror = function() {
                showToast('Error reading file', 'error');
                showUploadPlaceholder();
            };
            
            reader.readAsText(file);
        }
        
        function extractScriptMetadata(content, fileName) {
            const metadata = {
                name: fileName.replace(/\.(user\.)?js$/, ''),
                version: '1.0.0'
            };
            
            // Extract name from @name tag
            const nameMatch = content.match(/@name\s+(.+)/i);
            if (nameMatch) {
                metadata.name = nameMatch[1].trim();
            }
            
            // Extract version from @version tag
            const versionMatch = content.match(/@version\s+(.+)/i);
            if (versionMatch) {
                metadata.version = versionMatch[1].trim();
            }
            
            return metadata;
        }
        
        function showUploadPlaceholder() {
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadSuccess').classList.add('hidden');
        }
        
        function showUploadProgress() {
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadSuccess').classList.add('hidden');
            
            // Simulate progress
            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                progressBar.style.width = progress + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 100);
        }
        
        function showUploadSuccess(fileName, fileSize) {
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadSuccess').classList.remove('hidden');
            
            document.getElementById('uploadedFileName').textContent = fileName;
            document.getElementById('uploadedFileSize').textContent = formatFileSize(fileSize);
        }
        
        function showScriptPreview(content) {
            const lines = content.split('\n');
            const preview = lines.slice(0, 50).join('\n');
            
            document.getElementById('scriptPreview').textContent = preview;
            document.getElementById('scriptPreviewContainer').style.display = 'block';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function saveUploadedScript() {
            if (!window.uploadedScriptContent) {
                showToast('No script file uploaded', 'error');
                return;
            }
            
            const scriptName = document.getElementById('scriptName').value.trim();
            const scriptDescription = document.getElementById('scriptDescription').value.trim();
            const updateNotes = document.getElementById('updateNotes').value.trim();
            
            if (!scriptName) {
                showToast('Script name is required', 'error');
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                
                // Create FormData for file upload
                const formData = new FormData();
                
                // Create a blob from the script content
                const blob = new Blob([window.uploadedScriptContent], { type: 'text/javascript' });
                formData.append('files', blob, scriptName + '.user.js');
                formData.append('token', session.token);
                formData.append('scriptName', scriptName);
                formData.append('scriptDescription', scriptDescription);
                formData.append('updateNotes', updateNotes);
                
                showToast('Uploading script...', 'info');
                
                const response = await fetch('/.netlify/functions/scriptUpload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    cancelUpload();
                    loadScripts(); // Refresh script list
                } else {
                    showToast(result.message || 'Failed to upload script', 'error');
                }
            } catch (error) {
                console.error('Script upload error:', error);
                showToast('Failed to upload script', 'error');
            }
        }
        
        async function loadScripts() {
            const container = document.getElementById('scriptsList');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-code text-4xl mb-4"></i>
                    <p>Loading scripts...</p>
                </div>
            `;
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'listScripts',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayScripts(result.scripts || []);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Failed to load scripts: ${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load scripts error:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading scripts</p>
                    </div>
                `;
            }
        }
        
        // Helper function to safely format dates
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }
        
        function displayScripts(scripts) {
            const container = document.getElementById('scriptsList');
            
            if (scripts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-code text-4xl mb-4"></i>
                        <p>No scripts uploaded yet</p>
                        <p class="text-sm mt-2">Click "Upload Script File" to add your first script</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = scripts.map(script => `
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-code text-primary"></i>
                            </div>
                            <div>
                                <h4 class="font-medium">${script.name || 'Unnamed Script'}</h4>
                                <p class="text-sm text-gray-400">${script.description || 'No description'}</p>
                                <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
                                    <span>v${script.version || '1.0.0'}</span>
                                    <span>${formatFileSize(script.file_size || 0)}</span>
                                    <span>${formatDate(script.created_at)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                script.is_active ? 'bg-success/20 text-success' : 'bg-gray-600/20 text-gray-400'
                            }">
                                ${script.is_active ? 'Active' : 'Inactive'}
                            </span>
                            <button onclick="toggleScriptStatus('${script.id}', ${!script.is_active})" class="text-yellow-400 hover:text-yellow-300 p-2" title="${script.is_active ? 'Deactivate' : 'Activate'} Script">
                                <i class="fas fa-${script.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            <button onclick="viewScript('${script.id}')" class="text-blue-400 hover:text-blue-300 p-2" title="View Script">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteScript('${script.id}', '${script.name}')" class="text-red-400 hover:text-red-300 p-2" title="Delete Script">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${script.update_notes ? `
                        <div class="bg-white/5 rounded p-2 mb-2">
                            <p class="text-xs text-gray-400 mb-1">Release Notes:</p>
                            <p class="text-sm text-gray-300">${script.update_notes}</p>
                        </div>
                    ` : ''}
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>Created by: ${script.created_by || 'Admin'}</span>
                        <span>Downloads: ${script.downloads || 0}</span>
                        <span>Last updated: ${formatDate(script.updated_at)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function viewScript(scriptId) {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getScript',
                        token: session.token,
                        scriptId
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.script) {
                    showScriptModal(result.script);
                } else {
                    showToast('Failed to load script content', 'error');
                }
            } catch (error) {
                console.error('View script error:', error);
                showToast('Failed to load script content', 'error');
            }
        }
        
        function showScriptModal(script) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-xl p-6 max-w-4xl max-h-[80vh] overflow-auto m-4">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-semibold">${script.name}</h3>
                            <p class="text-sm text-gray-400">Version ${script.version} • ${formatFileSize(script.file_size || 0)}</p>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="bg-slate-900 rounded-lg p-4 border border-white/10 max-h-96 overflow-auto">
                        <pre class="text-sm font-mono text-gray-300 whitespace-pre-wrap">${script.content}</pre>
                    </div>
                    <div class="mt-4 text-xs text-gray-400">
                        <p>Last updated: ${new Date(script.updated_at).toLocaleString()}</p>
                        ${script.description ? `<p>Description: ${script.description}</p>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function toggleScriptStatus(scriptId, activate) {
            const action = activate ? 'activate' : 'deactivate';
            const actionText = activate ? 'activated' : 'deactivated';
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'toggleStatus',
                        token: session.token,
                        scriptId,
                        isActive: activate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Script ${actionText} successfully`, 'success');
                    loadScripts(); // Refresh script list
                } else {
                    showToast(result.message || `Failed to ${action} script`, 'error');
                }
            } catch (error) {
                console.error(`Toggle script status error:`, error);
                showToast(`Failed to ${action} script`, 'error');
            }
        }
        
        async function deleteScript(scriptId, scriptName) {
            if (!confirm(`Are you sure you want to delete the script "${scriptName}"?`)) {
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                const response = await fetch('/.netlify/functions/manageScripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteScript',
                        token: session.token,
                        scriptId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Script deleted successfully', 'success');
                    loadScripts(); // Refresh script list
                } else {
                    showToast(result.message || 'Failed to delete script', 'error');
                }
            } catch (error) {
                console.error('Delete script error:', error);
                showToast('Failed to delete script', 'error');
            }
        }
        
        // ===== LOGS MANAGEMENT FUNCTIONS =====
        
        function initLogs() {
            // Export logs button
            document.getElementById('exportLogsBtn')?.addEventListener('click', exportLogs);
            
            // Clear logs button
            document.getElementById('clearLogsBtn')?.addEventListener('click', clearLogs);
            
            // Refresh logs button
            document.getElementById('refreshLogsBtn')?.addEventListener('click', loadLogs);
            
            // Load logs on init
            loadLogs();
        }
        
        async function loadLogs() {
            const container = document.getElementById('logsList');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p>Loading logs...</p>
                </div>
            `;
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session || !session.token) {
                    throw new Error('No valid session found');
                }
                
                const response = await fetch('/.netlify/functions/logsManagement', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        action: 'getLogs',
                        token: session.token,
                        limit: 100
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayLogs(result.logs || []);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-red-400">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Failed to load logs: ${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load logs error:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading logs</p>
                    </div>
                `;
            }
        }
        
        function displayLogs(logs) {
            const container = document.getElementById('logsList');
            if (!container) return;
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-file-alt text-4xl mb-4"></i>
                        <p>No logs found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = logs.map(log => {
                const levelColors = {
                    'info': 'text-blue-400 bg-blue-400/10',
                    'warn': 'text-yellow-400 bg-yellow-400/10',
                    'error': 'text-red-400 bg-red-400/10',
                    'success': 'text-green-400 bg-green-400/10'
                };
                
                const levelColor = levelColors[log.level] || 'text-gray-400 bg-gray-400/10';
                
                return `
                    <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="px-2 py-1 text-xs rounded-full ${levelColor}">
                                        ${log.level.toUpperCase()}
                                    </span>
                                    <span class="text-xs text-gray-500">
                                        ${new Date(log.created_at).toLocaleString()}
                                    </span>
                                    ${log.username ? `<span class="text-xs text-gray-400">User: ${log.username}</span>` : ''}
                                </div>
                                <p class="text-sm text-gray-300 mb-1">${log.message}</p>
                                ${log.details ? `<p class="text-xs text-gray-500 font-mono">${log.details}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function exportLogs() {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session || !session.token) {
                    throw new Error('No valid session found');
                }
                
                showToast('Exporting logs...', 'info');
                
                const response = await fetch('/.netlify/functions/logsManagement', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        action: 'exportLogs',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Create and download CSV file
                    const blob = new Blob([result.csvData], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logs_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast('Logs exported successfully', 'success');
                } else {
                    showToast(result.message || 'Failed to export logs', 'error');
                }
            } catch (error) {
                console.error('Export logs error:', error);
                showToast('Failed to export logs', 'error');
            }
        }
        
        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session || !session.token) {
                    throw new Error('No valid session found');
                }
                
                showToast('Clearing logs...', 'info');
                
                const response = await fetch('/.netlify/functions/logsManagement', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        action: 'clearLogs',
                        token: session.token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Logs cleared successfully', 'success');
                    loadLogs(); // Refresh logs list
                } else {
                    showToast(result.message || 'Failed to clear logs', 'error');
                }
            } catch (error) {
                console.error('Clear logs error:', error);
                showToast('Failed to clear logs', 'error');
            }
        }
        
        // ===== TOKEN USAGE TRACKING FUNCTIONS =====
        
        async function loadTokenUsage(period = '7d') {
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session || !session.token) {
                    throw new Error('No valid session found');
                }
                
                const response = await fetch(`/.netlify/functions/getTokenUsage?period=${period}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateTokenUsageStats(result.data);
                    updateTokenUsageCharts(result.data);
                    updateTopUsersTable(result.data.charts.topUsers);
                } else {
                    console.error('Failed to load token usage:', result.message);
                    // Show fallback data
                    updateTokenUsageStats({
                        summary: {
                            totalTokens: 0,
                            activeUsers: 0,
                            avgTokensPerUser: 0,
                            mostActiveFeature: 'N/A'
                        }
                    });
                }
            } catch (error) {
                console.error('Token usage loading error:', error);
                // Show fallback data
                updateTokenUsageStats({
                    summary: {
                        totalTokens: 0,
                        activeUsers: 0,
                        avgTokensPerUser: 0,
                        mostActiveFeature: 'N/A'
                    }
                });
            }
        }
        
        function updateTokenUsageStats(data) {
            const summary = data.summary || {};
            
            document.getElementById('totalTokensCount').textContent = summary.totalTokens?.toLocaleString() || '0';
            document.getElementById('activeUsersCount').textContent = summary.activeUsers?.toString() || '0';
            document.getElementById('avgTokensPerUser').textContent = summary.avgTokensPerUser?.toString() || '0';
            document.getElementById('topFeature').textContent = summary.mostActiveFeature || 'N/A';
        }
        
        function updateTokenUsageCharts(data) {
            // Load the simple user token table instead of charts
            loadUserTokenUsage();
        }
        
        // Load and display user token usage in a simple table (ONCE per page load)
        let tokenUsageLoaded = false;
        async function loadUserTokenUsage() {
            const container = document.getElementById('userTokenTable');
            
            // Only load once per page session to prevent performance issues
            if (tokenUsageLoaded) {
                console.log('Token usage already loaded, skipping to prevent lag');
                return;
            }
            
            try {
                const session = JSON.parse(localStorage.getItem('adminSession'));
                if (!session || !session.token) {
                    throw new Error('No valid session found');
                }
                
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading user token usage...</p>
                    </div>
                `;
                
                const response = await fetch('/.netlify/functions/getTokenUsage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.token}`
                    },
                    body: JSON.stringify({
                        action: 'getUserTokenUsage'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.users && result.users.length > 0) {
                    const html = result.users.map((user, index) => `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-colors">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center">
                                    <span class="text-sm font-bold text-blue-400">${index + 1}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-white">${user.email}</p>
                                    <p class="text-xs text-gray-400">Last active: ${user.last_active || 'Unknown'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-blue-400">${user.token_count.toLocaleString()}</p>
                                <p class="text-xs text-gray-400">tokens</p>
                            </div>
                        </div>
                    `).join('');
                    
                    container.innerHTML = html;
                    tokenUsageLoaded = true; // Mark as loaded to prevent repeated calls
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p>No user token usage data available</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load user token usage error:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Failed to load user token usage</p>
                        <button onclick="loadUserTokenUsage()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function updateTopUsersTable(topUsers) {
            const container = document.getElementById('topUsersTable');
            if (!container) return;
            
            if (!topUsers || topUsers.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-between p-3 bg-white/5 rounded-lg"><span class="text-sm text-gray-400">No token usage data available</span></div>';
                return;
            }
            
            const html = topUsers.map((user, index) => `
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </div>
                        <div>
                            <p class="text-sm font-medium">${user.email}</p>
                            <p class="text-xs text-gray-400">${user.tokens} tokens</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="w-16 h-2 bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full" style="width: ${Math.min(100, (user.tokens / topUsers[0].tokens) * 100)}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // ===== NOTIFICATIONS MANAGEMENT FUNCTIONS =====
        
        function initNotifications() {
            // Add notification event listeners if needed
            // This is a placeholder for notification management functionality
        }
        
        function previewNotification() {
            // Placeholder for notification preview functionality
            showToast('Notification preview feature coming soon', 'info');
        }
        
        // ===== ADMIN PANEL CORE FUNCTIONS =====
        
        function logout() {
            // Clear session data
            localStorage.removeItem('adminSession');
            
            // Reset login state
            isLoggedIn = false;
            
            // Show login screen
            showLoginScreen();
            
            // Clear any sensitive data from memory
            window.adminSession = null;
            
            // Show logout message
            showToast('Logged out successfully', 'success');
            
            // Reset form
            document.getElementById('adminPassword').value = '';
        }
        
        function initAdminPanelButtons() {
            // Logout button
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            
            // Navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = e.currentTarget.getAttribute('href').substring(1);
                    showSection(target);
                    
                    // Update active nav link
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.remove('active', 'bg-white/20');
                    });
                    e.currentTarget.classList.add('active', 'bg-white/20');
                });
            });
            
            // Login form
            document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            
            // Login button
            document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
        }
        
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Update page title
            const titles = {
                'dashboard': { title: 'Dashboard', subtitle: 'System overview and statistics' },
                'script-management': { title: 'Script Management', subtitle: 'Upload and manage userscripts' },
                'system-settings': { title: 'System Settings', subtitle: 'Configure system parameters' },
                'notifications': { title: 'Notifications', subtitle: 'Manage system notifications' },
                'logs': { title: 'System Logs', subtitle: 'View and manage system logs' },
                'devices': { title: 'Device Management', subtitle: 'Manage registered devices' }
            };
            
            const titleInfo = titles[sectionName] || { title: 'Admin Panel', subtitle: 'System administration' };
            document.getElementById('pageTitle').textContent = titleInfo.title;
            document.getElementById('pageSubtitle').textContent = titleInfo.subtitle;
        }
        
        // ===== NOTIFICATIONS TAB FUNCTIONS =====
        
        function initNotifications() {
            // Initialize notification tabs
            initNotificationTabs();
            
            // Add other notification event listeners if needed
            // This is a placeholder for additional notification management functionality
        }

        // Initialize notification tabs
        function initNotificationTabs() {
            const notificationsTab = document.getElementById('notificationsTab');
            const paymentTab = document.getElementById('paymentTab');

            if (notificationsTab && paymentTab) {
                notificationsTab.addEventListener('click', () => switchNotificationTab('notifications'));
                paymentTab.addEventListener('click', () => switchNotificationTab('payment'));
            }
        }

        function switchNotificationTab(tab) {
            const notificationsTab = document.getElementById('notificationsTab');
            const paymentTab = document.getElementById('paymentTab');
            const notificationsContent = document.getElementById('notificationsContent');
            const paymentContent = document.getElementById('paymentContent');

            // Reset all tabs
            document.querySelectorAll('.notification-tab').forEach(t => {
                t.classList.remove('active', 'text-primary', 'border-primary');
                t.classList.add('text-gray-400', 'border-transparent');
            });

            // Hide all content
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.add('hidden');
            });

            // Show selected tab and content
            if (tab === 'notifications') {
                notificationsTab.classList.add('active', 'text-primary', 'border-primary');
                notificationsTab.classList.remove('text-gray-400', 'border-transparent');
                notificationsContent.classList.remove('hidden');
            } else if (tab === 'payment') {
                paymentTab.classList.add('active', 'text-primary', 'border-primary');
                paymentTab.classList.remove('text-gray-400', 'border-transparent');
                paymentContent.classList.remove('hidden');
            }
        }
        
        // Initialize all admin panel features
        function initAdminFeatures() {
            // Initialize core admin panel functionality first
            initAdminPanelButtons();
            
            // Initialize feature modules
            initDeviceManagement();
            initLogs();
            initNotifications();
            initSystemSettings();
            initScriptManagement();
            initTokenUsageTracking();
            initThemeSystem();
        }
        
        // Initialize token usage tracking
        function initTokenUsageTracking() {
            // Load user token usage table instead of charts
            loadUserTokenUsage();
        }
        
        // ===== THEME MANAGEMENT FUNCTIONS =====
        
        function initThemeSystem() {
            // Load saved theme or default to dark
            const savedTheme = localStorage.getItem('adminTheme') || 'dark';
            applyTheme(savedTheme);
            
            // Theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            const themeDropdown = document.getElementById('themeDropdown');
            
            if (themeToggle && themeDropdown) {
                themeToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    themeDropdown.classList.toggle('hidden');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!themeToggle.contains(e.target) && !themeDropdown.contains(e.target)) {
                        themeDropdown.classList.add('hidden');
                    }
                });
                
                // Theme option clicks
                const themeOptions = document.querySelectorAll('.theme-option');
                themeOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        const theme = e.currentTarget.getAttribute('data-theme');
                        applyTheme(theme);
                        localStorage.setItem('adminTheme', theme);
                        themeDropdown.classList.add('hidden');
                        showToast(`Theme changed to ${theme}`, 'success');
                    });
                });
            }
        }
        
        function applyTheme(theme) {
            // Remove existing theme attributes
            document.documentElement.removeAttribute('data-theme');
            
            // Apply new theme
            if (theme !== 'dark') {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            // Update body classes for compatibility
            const body = document.body;
            body.className = body.className.replace(/\bbg-gradient-to-br.*?\s/g, '');
            
            // Apply theme-specific body classes
            switch (theme) {
                case 'light':
                    body.classList.add('bg-gradient-to-br', 'from-gray-50', 'via-blue-50', 'to-gray-50', 'text-gray-900');
                    break;
                case 'blue':
                    body.classList.add('bg-gradient-to-br', 'from-blue-900', 'via-blue-800', 'to-blue-900', 'text-white');
                    break;
                case 'green':
                    body.classList.add('bg-gradient-to-br', 'from-green-900', 'via-green-800', 'to-green-900', 'text-white');
                    break;
                default: // dark
                    body.classList.add('bg-gradient-to-br', 'from-slate-900', 'via-purple-900', 'to-slate-900', 'text-white');
                    break;
            }
            
            // Refresh charts if they exist (to update colors)
            if (typeof tokenUsageChart !== 'undefined' && tokenUsageChart) {
                const currentPeriod = document.getElementById('tokenPeriodSelect')?.value || '7d';
                setTimeout(() => loadTokenUsage(currentPeriod), 100);
            }
        }
        
        // Initialize admin panel buttons and event handlers
        function initAdminPanelButtons() {
            // Notification tab switching
            const notificationTabs = document.querySelectorAll('.notification-tab');
            notificationTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active tab
                    notificationTabs.forEach(t => {
                        t.classList.remove('active', 'text-primary', 'border-primary');
                        t.classList.add('text-gray-400', 'border-transparent');
                    });
                    
                    this.classList.remove('text-gray-400', 'border-transparent');
                    this.classList.add('active', 'text-primary', 'border-primary');
                    
                    // Show/hide content
                    const targetContent = this.id === 'notificationsTab' ? 'notificationsContent' : 'paymentContent';
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetContent).classList.remove('hidden');
                });
            });
            
            // Send notification button
            const sendNotificationBtn = document.getElementById('sendNotificationBtn');
            if (sendNotificationBtn) {
                sendNotificationBtn.addEventListener('click', sendCustomNotification);
            }
            
            // Preview notification button
            const previewNotificationBtn = document.getElementById('previewNotificationBtn');
            if (previewNotificationBtn) {
                previewNotificationBtn.addEventListener('click', previewNotification);
            }
            
            // Test email button
            const testEmailBtn = document.getElementById('testEmailBtn');
            if (testEmailBtn) {
                testEmailBtn.addEventListener('click', sendTestEmail);
            }
            
            // Save email config button
            const saveEmailConfigBtn = document.getElementById('saveEmailConfigBtn');
            if (saveEmailConfigBtn) {
                saveEmailConfigBtn.addEventListener('click', saveEmailConfiguration);
            }
            
            // Custom email recipient toggle
            const notificationRecipient = document.getElementById('notificationRecipient');
            if (notificationRecipient) {
                notificationRecipient.addEventListener('change', function() {
                    const customEmailDiv = document.getElementById('customEmailDiv');
                    if (this.value === 'custom') {
                        customEmailDiv.classList.remove('hidden');
                    } else {
                        customEmailDiv.classList.add('hidden');
                    }
                });
            }
        }
        
        // Send custom notification
        async function sendCustomNotification() {
            const recipient = document.getElementById('notificationRecipient').value;
            const customEmail = document.getElementById('customEmail').value;
            const subject = document.getElementById('notificationSubject').value;
            const message = document.getElementById('notificationMessage').value;
            
            if (!subject || !message) {
                showToast('Please fill in subject and message', 'error');
                return;
            }
            
            if (recipient === 'custom' && !customEmail) {
                showToast('Please enter custom email address', 'error');
                return;
            }
            
            const session = JSON.parse(localStorage.getItem('adminSession'));
            if (!session?.token) {
                showToast('Admin session expired', 'error');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'testNotification',
                        token: session.token,
                        email: recipient === 'custom' ? customEmail : 'admin@example.com',
                        type: 'custom'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Notification sent successfully!', 'success');
                    // Clear form
                    document.getElementById('notificationSubject').value = '';
                    document.getElementById('notificationMessage').value = '';
                    document.getElementById('customEmail').value = '';
                } else {
                    showToast('Failed to send notification: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Send notification error:', error);
                showToast('Failed to send notification', 'error');
            }
        }
        
        // Preview notification
        function previewNotification() {
            const recipient = document.getElementById('notificationRecipient').value;
            const customEmail = document.getElementById('customEmail').value;
            const subject = document.getElementById('notificationSubject').value;
            const message = document.getElementById('notificationMessage').value;
            
            if (!subject || !message) {
                showToast('Please fill in subject and message to preview', 'error');
                return;
            }
            
            const recipientEmail = recipient === 'custom' ? customEmail : 
                                 recipient === 'admin' ? 'admin@example.com' : 'all_users@example.com';
            
            // Create preview modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">📧 Notification Preview</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white/10 rounded-lg p-4">
                            <div class="text-sm text-gray-400 mb-2">To: ${recipientEmail}</div>
                            <div class="text-sm text-gray-400 mb-2">Subject: ${subject}</div>
                            <div class="border-t border-white/20 pt-4 mt-4">
                                <div class="text-white whitespace-pre-wrap">${message}</div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Send test email
        async function sendTestEmail() {
            const adminEmail = document.getElementById('adminEmail').value;
            
            if (!adminEmail) {
                showToast('Please enter admin email address', 'error');
                return;
            }
            
            const session = JSON.parse(localStorage.getItem('adminSession'));
            if (!session?.token) {
                showToast('Admin session expired', 'error');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'testNotification',
                        token: session.token,
                        email: adminEmail,
                        type: 'test'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Test email sent successfully!', 'success');
                } else {
                    showToast('Failed to send test email: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Test email error:', error);
                showToast('Failed to send test email', 'error');
            }
        }
        
        // Save email configuration
        async function saveEmailConfiguration() {
            const emailConfig = {
                emailjs_service_id: document.getElementById('emailjsServiceId').value,
                emailjs_template_id: document.getElementById('emailjsTemplateId').value,
                emailjs_public_key: document.getElementById('emailjsPublicKey').value,
                admin_email: document.getElementById('adminEmail').value
            };
            
            const session = JSON.parse(localStorage.getItem('adminSession'));
            if (!session?.token) {
                showToast('Admin session expired', 'error');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/managePaymentSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        token: session.token,
                        settings: emailConfig
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('Email configuration saved successfully!', 'success');
                } else {
                    showToast('Failed to save configuration: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Save email config error:', error);
                showToast('Failed to save configuration', 'error');
            }
        }
        
        // Initialize admin panel on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in with improved session validation
            const session = localStorage.getItem('adminSession');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    const now = Date.now();
                    const sessionExpiry = sessionData.expires || sessionData.expiry;
                    
                    if (sessionData.token && sessionExpiry > now) {
                        // Update last activity and extend session if needed
                        sessionData.lastActivity = now;
                        
                        // Auto-extend session if it's within 24 hours of expiry
                        if (sessionExpiry - now < (24 * 60 * 60 * 1000)) {
                            sessionData.expires = now + (7 * 24 * 60 * 60 * 1000);
                            sessionData.expiry = now + (7 * 24 * 60 * 60 * 1000);
                            localStorage.setItem('adminSession', JSON.stringify(sessionData));
                        }
                        
                        showAdminInterface();
                    } else {
                        localStorage.removeItem('adminSession');
                        showLoginScreen();
                    }
                } catch (error) {
                    console.error('Session validation error:', error);
                    localStorage.removeItem('adminSession');
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
            
            // Initialize basic button functionality even before login
            initAdminPanelButtons();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                showToast('Developer tools are disabled', 'warning');
            }
        });
    </script>
</body>
</html>
